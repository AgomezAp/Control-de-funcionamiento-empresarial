# üîß FIX: Categor√≠as de Gesti√≥n Administrativa mostrando precio incorrecto

## üéØ Problema Identificado

El usuario reporta que las categor√≠as de **Gesti√≥n Administrativa** est√°n mostrando un costo de **$60.000** en el frontend, cuando deber√≠an mostrar **$0** (costo cero).

### Evidencia del Problema:
```
üì∏ Screenshot muestra:
√Årea: Gesti√≥n Administrativa
Costo: $ 60.000  ‚Üê ‚ùå INCORRECTO
```

### Causa Ra√≠z:
La base de datos tiene categor√≠as de Gesti√≥n Administrativa con costos diferentes de 0, probablemente creadas antes de la √∫ltima actualizaci√≥n del `init-data.ts`.

---

## ‚úÖ Verificaciones Realizadas

### 1. Backend - Modelo Categoria ‚úÖ
```typescript
// Backend/src/models/Categoria.ts

export class Categoria extends Model {
  public id!: number;
  public nombre!: string;
  public area_tipo!: "Dise√±o" | "Pautas" | "Gesti√≥n Administrativa";
  public costo!: number; // ‚Üê Campo existe
  public es_variable!: boolean;
  public requiere_descripcion_extra!: boolean;
}
```
**Estado**: ‚úÖ Correcto - El modelo tiene el campo `costo`

### 2. Backend - Init-Data ‚úÖ
```typescript
// Backend/src/scripts/init-data.ts (l√≠neas 303-371)

const categoriasGestionAdmin = [
  {
    nombre: "Reporte de problema - Cliente",
    area_tipo: "Gesti√≥n Administrativa",
    costo: 0, // ‚Üê ‚úÖ COSTO 0
    es_variable: false,
    requiere_descripcion_extra: true,
  },
  {
    nombre: "Solicitud de soporte t√©cnico",
    area_tipo: "Gesti√≥n Administrativa",
    costo: 0, // ‚Üê ‚úÖ COSTO 0
    es_variable: false,
    requiere_descripcion_extra: true,
  },
  // ... 6 categor√≠as m√°s, todas con costo: 0
];
```
**Estado**: ‚úÖ Correcto - Todas las categor√≠as de GA tienen `costo: 0`

### 3. Backend - API Endpoint ‚úÖ
```typescript
// Backend/src/controllers/categoria.controller.ts
// Backend/src/services/categoria.service.ts

async obtenerPorArea(area: string): Promise<Categoria[]> {
  const categorias = await Categoria.findAll({
    where: { area_tipo: area },
    order: [["nombre", "ASC"]],
  });
  return categorias;
}
```
**Estado**: ‚úÖ Correcto - Retorna todas las categor√≠as con todos los campos

### 4. Frontend - Servicio ‚úÖ
```typescript
// Front/src/app/core/services/categoria.service.ts

getByArea(area: AreaTipo): Observable<Categoria[]> {
  return this.http.get<{ success: boolean; data: Categoria[] }>(
    `${this.apiUrl}/area/${area}`
  ).pipe(map(response => response.data));
}
```
**Estado**: ‚úÖ Correcto - Consume la API correctamente

### 5. Frontend - Constantes Eliminadas ‚úÖ
```bash
# B√∫squeda en todos los archivos:
grep -r "categorias.constants" Front/src/**/*.ts
# Resultado: No matches found
```
**Estado**: ‚úÖ Correcto - Ya no se usan constantes hardcodeadas

### 6. Frontend - HTML Mostrando Costo ‚úÖ
```html
<!-- crear-peticion.component.html (l√≠nea 156) -->

<div class="info-item">
  <span class="info-label">Costo:</span>
  <span class="info-value highlight">{{
    categoriaSeleccionada.costo | currencyCop
  }}</span>
</div>
```
**Estado**: ‚úÖ Correcto - Muestra el costo que viene del backend

---

## üîç Diagn√≥stico Final

**El problema NO est√° en el c√≥digo, est√° en los DATOS de la base de datos.**

La base de datos actual tiene categor√≠as de Gesti√≥n Administrativa creadas con costos incorrectos (ej: $60.000). El `init-data.ts` crea categor√≠as con `costo: 0`, pero si ya existen en la BD, el m√©todo `findOrCreate` NO las actualiza.

```typescript
// init-data.ts usa findOrCreate
await Categoria.findOrCreate({
  where: { nombre: cat.nombre },
  defaults: cat, // ‚Üê Solo se usa si NO existe
});
```

Si la categor√≠a ya existe con `costo: 60000`, **NO se actualiza a 0**.

---

## üõ†Ô∏è SOLUCI√ìN 1: Script de Actualizaci√≥n (RECOMENDADA)

He creado un script espec√≠fico para actualizar SOLO las categor√≠as de Gesti√≥n Administrativa:

```typescript
// Backend/src/scripts/actualizar-categorias-ga.ts

import sequelize from "../database/connection";
import Categoria from "../models/Categoria";
import "../models/Relaciones";

async function actualizarCategoriasGA() {
  try {
    console.log("üîÑ Actualizando categor√≠as de Gesti√≥n Administrativa...");

    await sequelize.authenticate();
    console.log("‚úÖ Conectado a la base de datos");

    // Actualizar TODAS las categor√≠as de GA para que tengan costo 0
    const [affectedCount] = await Categoria.update(
      { costo: 0 },
      {
        where: {
          area_tipo: "Gesti√≥n Administrativa",
        },
      }
    );

    console.log(`‚úÖ Se actualizaron ${affectedCount} categor√≠as de Gesti√≥n Administrativa`);
    console.log("   Todas las categor√≠as de GA ahora tienen costo: $0");

    // Mostrar las categor√≠as actualizadas
    const categoriasGA = await Categoria.findAll({
      where: { area_tipo: "Gesti√≥n Administrativa" },
      attributes: ["id", "nombre", "costo", "area_tipo"],
      order: [["nombre", "ASC"]],
    });

    console.log("\nüìã Categor√≠as de Gesti√≥n Administrativa:");
    categoriasGA.forEach((cat) => {
      console.log(`   ‚Ä¢ ${cat.nombre} - Costo: $${cat.costo}`);
    });

    await sequelize.close();
    console.log("\n‚úÖ Actualizaci√≥n completada exitosamente");
    process.exit(0);
  } catch (error) {
    console.error("‚ùå Error al actualizar categor√≠as:", error);
    await sequelize.close();
    process.exit(1);
  }
}

actualizarCategoriasGA();
```

### Agregar script al package.json:

```json
{
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "dev": "nodemon dist/index.js",
    "start": "nodemon dist/index.js",
    "init-data": "ts-node src/scripts/init-data.ts",
    "actualizar-categorias-ga": "ts-node src/scripts/actualizar-categorias-ga.ts",
    "typescript": "tsc --watch"
  }
}
```

### Ejecutar el script:

```bash
cd Backend
npm run actualizar-categorias-ga
```

**Resultado esperado**:
```
üîÑ Actualizando categor√≠as de Gesti√≥n Administrativa...
‚úÖ Conectado a la base de datos
‚úÖ Se actualizaron 8 categor√≠as de Gesti√≥n Administrativa
   Todas las categor√≠as de GA ahora tienen costo: $0

üìã Categor√≠as de Gesti√≥n Administrativa:
   ‚Ä¢ Consulta general del cliente - Costo: $0
   ‚Ä¢ Escalamiento de caso - Costo: $0
   ‚Ä¢ Incidencia con campa√±a - Costo: $0
   ‚Ä¢ Otro - Especificar - Costo: $0
   ‚Ä¢ Problema con dise√±o web - Costo: $0
   ‚Ä¢ Reporte de problema - Cliente - Costo: $0
   ‚Ä¢ Seguimiento de solicitud - Costo: $0
   ‚Ä¢ Solicitud de soporte t√©cnico - Costo: $0

‚úÖ Actualizaci√≥n completada exitosamente
```

---

## üõ†Ô∏è SOLUCI√ìN 2: Resetear Base de Datos Completa

Si prefieres empezar desde cero (esto BORRAR√Å todos los datos):

### Opci√≥n A: Modificar server.ts temporalmente

```typescript
// Backend/src/models/server.ts (l√≠nea 43)

// CAMBIAR TEMPORALMENTE:
await sequelize.sync({ alter: false }); // ‚Üê De esto
await sequelize.sync({ force: true });  // ‚Üê A esto (UNA SOLA VEZ)
```

**Luego ejecutar**:
```bash
cd Backend
npm run dev  # Esto resetear√° la BD
# Presionar Ctrl+C
# Volver a cambiar force: true ‚Üí alter: false
npm run init-data  # Crear datos de prueba
npm run dev  # Iniciar servidor normal
```

### Opci√≥n B: Eliminar tabla manualmente

```sql
-- Conectarse a PostgreSQL
psql -U postgres -d nombre_de_tu_base_de_datos

-- Eliminar SOLO la tabla de categor√≠as
DROP TABLE IF EXISTS categorias CASCADE;

-- Salir
\q
```

**Luego ejecutar**:
```bash
cd Backend
npm run dev  # Esto crear√° la tabla de nuevo
# Presionar Ctrl+C
npm run init-data  # Crear datos
npm run dev  # Iniciar servidor
```

---

## üõ†Ô∏è SOLUCI√ìN 3: Actualizaci√≥n Manual SQL

Si prefieres ejecutar SQL directamente:

```sql
-- Conectarse a PostgreSQL
psql -U postgres -d nombre_de_tu_base_de_datos

-- Actualizar todas las categor√≠as de Gesti√≥n Administrativa
UPDATE categorias 
SET costo = 0 
WHERE area_tipo = 'Gesti√≥n Administrativa';

-- Verificar el cambio
SELECT id, nombre, area_tipo, costo 
FROM categorias 
WHERE area_tipo = 'Gesti√≥n Administrativa'
ORDER BY nombre;

-- Salir
\q
```

---

## ‚úÖ Verificaci√≥n Post-Fix

Despu√©s de aplicar cualquiera de las soluciones:

### 1. Backend - Verificar API:
```bash
# Ejecutar en terminal o navegador:
curl http://localhost:3010/api/categorias/area/Gesti√≥n%20Administrativa

# O en navegador:
http://localhost:3010/api/categorias/area/Gesti√≥n%20Administrativa
```

**Respuesta esperada**:
```json
{
  "success": true,
  "data": [
    {
      "id": 32,
      "nombre": "Reporte de problema - Cliente",
      "area_tipo": "Gesti√≥n Administrativa",
      "costo": "0.00",  ‚Üê ‚úÖ DEBE SER 0
      "es_variable": false,
      "requiere_descripcion_extra": true
    },
    // ... m√°s categor√≠as
  ],
  "message": "Categor√≠as del √°rea Gesti√≥n Administrativa obtenidas exitosamente"
}
```

### 2. Frontend - Verificar Vista:
```bash
# 1. Iniciar Frontend
cd Front
ng serve

# 2. Login con usuario de GA
Usuario: laura.admin@empresa.com
Password: 123456

# 3. Ir a Crear Petici√≥n
Peticiones ‚Üí Crear Nueva

# 4. Seleccionar categor√≠a
√Årea: Gesti√≥n Administrativa (bloqueada)
Categor√≠a: "Actualizaci√≥n de base de datos"

# 5. Verificar costo mostrado
‚úÖ Debe mostrar: Costo: $ 0
‚ùå NO debe mostrar: Costo: $ 60.000
```

### 3. Consola del Navegador:
```javascript
// Abrir DevTools (F12) ‚Üí Console
// Buscar logs del servicio:
üì¶ Categor√≠as cargadas desde backend: 8
‚úÖ Categor√≠as filtradas para "Gesti√≥n Administrativa": 8
üìã Categor√≠as: [
  "Consulta general del cliente",
  "Escalamiento de caso",
  "Incidencia con campa√±a",
  "Otro - Especificar",
  "Problema con dise√±o web",
  "Reporte de problema - Cliente",
  "Seguimiento de solicitud",
  "Solicitud de soporte t√©cnico"
]
```

---

## üìä Comparaci√≥n de Soluciones

| Soluci√≥n | Velocidad | Riesgo | Datos Perdidos | Recomendada |
|----------|-----------|--------|----------------|-------------|
| **Script actualizar-categorias-ga** | ‚ö° R√°pida (5s) | üü¢ Bajo | ‚ùå Ninguno | ‚úÖ **S√ç** |
| **Resetear BD completa** | ‚è±Ô∏è Media (30s) | üü° Medio | ‚ö†Ô∏è Todos | ‚ùå No |
| **SQL Manual** | ‚ö° R√°pida (10s) | üü¢ Bajo | ‚ùå Ninguno | ‚úÖ S√≠ |

---

## üöÄ Pasos Recomendados (EN ORDEN)

### Paso 1: Ejecutar Script de Actualizaci√≥n
```bash
cd c:\Users\DESARROLLO\Documents\Codigos\Factura\Backend
npm run actualizar-categorias-ga
```

### Paso 2: Verificar Backend API
```bash
# Iniciar backend (si no est√° corriendo)
npm run dev

# En navegador:
http://localhost:3010/api/categorias/area/Gesti√≥n%20Administrativa
```

### Paso 3: Verificar Frontend
```bash
# Terminal 2 - Frontend
cd c:\Users\DESARROLLO\Documents\Codigos\Factura\Front
ng serve

# Navegador:
http://localhost:4200
# Login: laura.admin@empresa.com / 123456
# Ir a: Peticiones ‚Üí Crear Nueva
# Seleccionar categor√≠a y verificar costo: $0
```

---

## üìù Notas Importantes

1. **El c√≥digo est√° correcto**: Frontend y backend est√°n bien implementados
2. **El problema es DATA**: La BD tiene datos viejos con costos incorrectos
3. **Constantes eliminadas**: Ya no se usan archivos hardcodeados
4. **API funcionando**: El endpoint retorna correctamente los datos de la BD
5. **Soluci√≥n segura**: El script solo actualiza categor√≠as de GA, no afecta otras √°reas

---

## ‚úÖ Resultado Final Esperado

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Creando petici√≥n para el √°rea de                  ‚îÇ
‚îÇ  Gesti√≥n Administrativa                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ  üìã Seleccionar Categor√≠a *                         ‚îÇ
‚îÇ  [Actualizaci√≥n de base de datos        ‚ñº]         ‚îÇ
‚îÇ                                                     ‚îÇ
‚îÇ  üè∑Ô∏è Actualizaci√≥n de base de datos                 ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  ‚îÇ √Årea:  Gesti√≥n Administrativa                 ‚îÇ ‚îÇ
‚îÇ  ‚îÇ Costo: $ 0  ‚Üê ‚úÖ CORRECTO                      ‚îÇ ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üìÑ Archivos Creados

1. **`Backend/src/scripts/actualizar-categorias-ga.ts`** - Script de actualizaci√≥n
2. **`FIX_CATEGORIAS_COSTO_GA.md`** - Este documento (documentaci√≥n completa)

---

**¬°Con esto quedar√°n actualizadas todas las categor√≠as de Gesti√≥n Administrativa con costo $0!** üéâ
