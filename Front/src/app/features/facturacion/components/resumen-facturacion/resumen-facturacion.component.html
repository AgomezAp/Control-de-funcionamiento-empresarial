<div class="facturacion-resumen-container">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header con filtros -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <i class="pi pi-file-excel"></i>
        <h2>Resumen de Facturación</h2>
      </div>

      <div class="header-actions">
        <p-dropdown
          [options]="meses"
          [(ngModel)]="selectedMes"
          placeholder="Seleccionar mes"
          optionLabel="label"
          optionValue="value"
          (onChange)="onFiltroChange()"
          styleClass="custom-dropdown"
        ></p-dropdown>

        <p-dropdown
          [options]="anios"
          [(ngModel)]="selectedAnio"
          placeholder="Seleccionar año"
          optionLabel="label"
          optionValue="value"
          (onChange)="onFiltroChange()"
          styleClass="custom-dropdown"
        ></p-dropdown>

        <button
          pButton
          icon="pi pi-refresh"
          label="Actualizar"
          (click)="loadResumen()"
          [loading]="loading"
          class="btn-refresh"
        ></button>

        <button
          pButton
          icon="pi pi-bolt"
          label="Facturación Automática"
          (click)="generarAutomatica()"
          [loading]="loading"
          class="btn-automatic"
          pTooltip="Generar facturación para todas las peticiones resueltas del periodo"
          tooltipPosition="bottom"
        ></button>

        <button
          pButton
          icon="pi pi-plus"
          label="Generar Facturación"
          (click)="irAGenerar()"
          class="btn-generate"
        ></button>
      </div>
    </div>
  </div>

  <!-- Cards de resumen -->
  <div *ngIf="!loading && resumen" class="stats-grid">
    <!-- Total Clientes -->
    <div class="stat-card card-blue">
      <div class="stat-icon">
        <i class="pi pi-users"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Total Clientes</p>
        <p class="stat-value">{{ resumen.totales.total_clientes }}</p>
      </div>
      <div class="stat-decoration"></div>
    </div>

    <!-- Total Peticiones -->
    <div class="stat-card card-purple">
      <div class="stat-icon">
        <i class="pi pi-file"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Total Peticiones</p>
        <p class="stat-value">{{ resumen.totales.total_peticiones }}</p>
      </div>
      <div class="stat-decoration"></div>
    </div>

    <!-- Costo Total -->
    <div class="stat-card card-green">
      <div class="stat-icon">
        <i class="pi pi-dollar"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Costo Total</p>
        <p class="stat-value">
          ${{ resumen.totales.costo_total | number : "1.2-2" }}
        </p>
      </div>
      <div class="stat-decoration"></div>
    </div>

    <!-- Por Estado -->
    <div class="stat-card card-yellow">
      <div class="stat-icon">
        <i class="pi pi-chart-pie"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Por Estado</p>
        <div class="estados-grid">
          <div class="estado-item">
            <p class="estado-value estado-abierto">
              {{ resumen.totales.por_estado.abiertos }}
            </p>
            <p class="estado-label">Abiertos</p>
          </div>
          <div class="estado-item">
            <p class="estado-value estado-cerrado">
              {{ resumen.totales.por_estado.cerrados }}
            </p>
            <p class="estado-label">Cerrados</p>
          </div>
          <div class="estado-item">
            <p class="estado-value estado-facturado">
              {{ resumen.totales.por_estado.facturados }}
            </p>
            <p class="estado-label">Facturados</p>
          </div>
        </div>
      </div>
      <div class="stat-decoration"></div>
    </div>
  </div>

  <!-- Skeleton Loading -->
  <div *ngIf="loading" class="loading-skeleton">
    <div class="skeleton-card">
      <p-skeleton width="100%" height="500px" borderRadius="16px"></p-skeleton>
    </div>
  </div>

  <!-- Mensaje sin datos -->
  <div *ngIf="!loading && periodos.length === 0" class="empty-state">
    <div class="empty-state-content">
      <i class="pi pi-inbox"></i>
      <h3>No hay periodos de facturación</h3>
      <p>No se han generado periodos para este mes</p>
      <button
        pButton
        icon="pi pi-plus"
        label="Generar Facturación"
        (click)="irAGenerar()"
        class="btn-generate"
      ></button>
    </div>
  </div>

  <!-- Tabla de periodos -->
  <div *ngIf="!loading && periodos.length > 0" class="table-card">
    <div class="table-header">
      <i class="pi pi-list"></i>
      <h3>Periodos de Facturación</h3>
    </div>

    <div class="table-content">
      <p-table
        [value]="periodos"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} periodos"
        [rowsPerPageOptions]="[10, 25, 50]"
        styleClass="custom-table"
        [rowHover]="true"
        [tableStyle]="{ 'min-width': '50rem' }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="cliente.nombre">
              <div class="th-content">
                <span>Cliente</span>
                <p-sortIcon field="cliente.nombre"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="año" class="text-center">
              <div class="th-content">
                <span>Periodo</span>
                <p-sortIcon field="año"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="total_peticiones" class="text-center">
              <div class="th-content">
                <span>Peticiones</span>
                <p-sortIcon field="total_peticiones"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="costo_total" class="text-right">
              <div class="th-content">
                <span>Costo Total</span>
                <p-sortIcon field="costo_total"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="estado" class="text-center">
              <div class="th-content">
                <span>Estado</span>
                <p-sortIcon field="estado"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="fecha_generacion" class="text-center">
              <div class="th-content">
                <span>Generado</span>
                <p-sortIcon field="fecha_generacion"></p-sortIcon>
              </div>
            </th>
            <th class="text-center">Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-periodo>
          <tr>
            <td>
              <div class="client-cell">
                <i class="pi pi-building"></i>
                <div class="client-info">
                  <span class="client-name">{{ periodo.cliente?.nombre }}</span>
                  <span class="client-country">{{
                    periodo.cliente?.pais
                  }}</span>
                </div>
              </div>
            </td>
            <td class="text-center">
              <span class="periodo-badge">{{ getPeriodoLabel(periodo) }}</span>
            </td>
            <td class="text-center">
              <span class="badge badge-blue">{{
                periodo.total_peticiones
              }}</span>
            </td>
            <td class="text-right">
              <span class="cell-amount"
                >${{ periodo.costo_total | number : "1.2-2" }}</span
              >
            </td>
            <td class="text-center">
              <p-tag
                [value]="periodo.estado"
                [severity]="getEstadoSeverity(periodo.estado)"
                styleClass="custom-tag"
              ></p-tag>
            </td>
            <td class="text-center">
              <span class="date-cell">{{
                periodo.fecha_generacion | date : "dd/MM/yyyy"
              }}</span>
            </td>
            <td>
              <div class="actions-cell">
                <button
                  pButton
                  icon="pi pi-eye"
                  class="p-button-rounded p-button-text action-btn btn-view"
                  pTooltip="Ver Detalle"
                  tooltipPosition="top"
                  (click)="verDetalle(periodo)"
                ></button>

                <button
                  pButton
                  icon="pi pi-file-pdf"
                  class="p-button-rounded p-button-text action-btn btn-pdf"
                  pTooltip="Exportar PDF"
                  tooltipPosition="top"
                  (click)="exportarPDF(periodo)"
                  [disabled]="!puedeModificar(periodo.estado)"
                ></button>

                <button
                  *ngIf="periodo.estado === 'Abierto'"
                  pButton
                  icon="pi pi-lock"
                  class="p-button-rounded p-button-text action-btn btn-close"
                  pTooltip="Cerrar Periodo"
                  tooltipPosition="top"
                  (click)="cerrarPeriodo(periodo)"
                ></button>

                <button
                  *ngIf="periodo.estado === 'Cerrado'"
                  pButton
                  icon="pi pi-check"
                  class="p-button-rounded p-button-text action-btn btn-facturar"
                  pTooltip="Marcar como Facturado"
                  tooltipPosition="top"
                  (click)="facturarPeriodo(periodo)"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7">
              <div class="empty-table">
                <i class="pi pi-inbox"></i>
                <p>No hay periodos disponibles</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
