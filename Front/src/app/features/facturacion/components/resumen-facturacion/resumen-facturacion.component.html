<div class="container mx-auto p-4">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- Header con filtros -->
  <div class="mb-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-3xl font-bold text-gray-800">
        <i class="pi pi-file-excel text-orange-600 mr-2"></i>
        Resumen de Facturación
      </h2>

      <div class="flex gap-3">
        <p-dropdown
          [options]="meses"
          [(ngModel)]="selectedMes"
          placeholder="Mes"
          optionLabel="label"
          optionValue="value"
          (onChange)="onFiltroChange()"
          [style]="{ width: '150px' }"
        ></p-dropdown>

        <p-dropdown
          [options]="anios"
          [(ngModel)]="selectedAnio"
          placeholder="Año"
          optionLabel="label"
          optionValue="value"
          (onChange)="onFiltroChange()"
          [style]="{ width: '120px' }"
        ></p-dropdown>

        <button
          pButton
          icon="pi pi-refresh"
          label="Actualizar"
          (click)="loadResumen()"
          [loading]="loading"
          class="p-button-outlined"
        ></button>

        <button
          pButton
          icon="pi pi-plus"
          label="Generar Facturación"
          (click)="irAGenerar()"
          class="p-button-success"
        ></button>
      </div>
    </div>
  </div>

  <!-- Cards de resumen -->
  <div *ngIf="!loading && resumen" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    <p-card class="bg-blue-50">
      <div class="text-center">
        <i class="pi pi-users text-3xl text-blue-600 mb-2"></i>
        <p class="text-sm text-gray-600 mb-1">Total Clientes</p>
        <p class="text-3xl font-bold text-blue-700">{{ resumen.totales.total_clientes }}</p>
      </div>
    </p-card>

    <p-card class="bg-purple-50">
      <div class="text-center">
        <i class="pi pi-file text-3xl text-purple-600 mb-2"></i>
        <p class="text-sm text-gray-600 mb-1">Total Peticiones</p>
        <p class="text-3xl font-bold text-purple-700">{{ resumen.totales.total_peticiones }}</p>
      </div>
    </p-card>

    <p-card class="bg-green-50">
      <div class="text-center">
        <i class="pi pi-dollar text-3xl text-green-600 mb-2"></i>
        <p class="text-sm text-gray-600 mb-1">Costo Total</p>
        <p class="text-2xl font-bold text-green-700">${{ resumen.totales.costo_total | number: '1.2-2' }}</p>
      </div>
    </p-card>

    <p-card class="bg-orange-50">
      <div class="text-center">
        <i class="pi pi-chart-pie text-3xl text-orange-600 mb-2"></i>
        <p class="text-xs text-gray-600 mb-2">Por Estado</p>
        <div class="flex justify-around text-sm">
          <div>
            <p class="font-bold text-blue-600">{{ resumen.totales.por_estado.abiertos }}</p>
            <p class="text-xs">Abiertos</p>
          </div>
          <div>
            <p class="font-bold text-yellow-600">{{ resumen.totales.por_estado.cerrados }}</p>
            <p class="text-xs">Cerrados</p>
          </div>
          <div>
            <p class="font-bold text-green-600">{{ resumen.totales.por_estado.facturados }}</p>
            <p class="text-xs">Facturados</p>
          </div>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Skeleton Loading -->
  <div *ngIf="loading">
    <p-card>
      <p-skeleton width="100%" height="500px"></p-skeleton>
    </p-card>
  </div>

  <!-- Mensaje sin datos -->
  <div *ngIf="!loading && periodos.length === 0" class="text-center py-12">
    <p-card>
      <i class="pi pi-inbox text-6xl text-gray-400 mb-4"></i>
      <h3 class="text-2xl font-bold mb-2">No hay periodos de facturación</h3>
      <p class="text-gray-600 mb-4">
        No se han generado periodos para este mes
      </p>
      <button
        pButton
        icon="pi pi-plus"
        label="Generar Facturación"
        (click)="irAGenerar()"
        class="p-button-success"
      ></button>
    </p-card>
  </div>

  <!-- Tabla de periodos -->
  <div *ngIf="!loading && periodos.length > 0">
    <p-card>
      <ng-template pTemplate="header">
        <div class="p-4">
          <h3 class="text-xl font-bold">Periodos de Facturación</h3>
        </div>
      </ng-template>

      <p-table
        [value]="periodos"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} periodos"
        [rowsPerPageOptions]="[10, 25, 50]"
        styleClass="p-datatable-sm"
        [tableStyle]="{ 'min-width': '50rem' }"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="cliente.nombre">
              Cliente
              <p-sortIcon field="cliente.nombre"></p-sortIcon>
            </th>
            <th pSortableColumn="año" class="text-center">
              Periodo
              <p-sortIcon field="año"></p-sortIcon>
            </th>
            <th pSortableColumn="total_peticiones" class="text-center">
              Peticiones
              <p-sortIcon field="total_peticiones"></p-sortIcon>
            </th>
            <th pSortableColumn="costo_total" class="text-right">
              Costo Total
              <p-sortIcon field="costo_total"></p-sortIcon>
            </th>
            <th pSortableColumn="estado" class="text-center">
              Estado
              <p-sortIcon field="estado"></p-sortIcon>
            </th>
            <th pSortableColumn="fecha_generacion" class="text-center">
              Generado
              <p-sortIcon field="fecha_generacion"></p-sortIcon>
            </th>
            <th class="text-center">Acciones</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-periodo>
          <tr>
            <td>
              <div class="flex items-center gap-2">
                <i class="pi pi-building text-gray-500"></i>
                <div>
                  <div class="font-semibold">{{ periodo.cliente?.nombre }}</div>
                  <div class="text-xs text-gray-500">{{ periodo.cliente?.pais }}</div>
                </div>
              </div>
            </td>
            <td class="text-center">
              <span class="font-semibold">{{ getPeriodoLabel(periodo) }}</span>
            </td>
            <td class="text-center">
              <span class="font-semibold">{{ periodo.total_peticiones }}</span>
            </td>
            <td class="text-right">
              <span class="font-bold text-green-700">${{ periodo.costo_total | number: '1.2-2' }}</span>
            </td>
            <td class="text-center">
              <p-tag
                [value]="periodo.estado"
                [severity]="getEstadoSeverity(periodo.estado)"
              ></p-tag>
            </td>
            <td class="text-center text-sm text-gray-600">
              {{ periodo.fecha_generacion | date: 'dd/MM/yyyy' }}
            </td>
            <td class="text-center">
              <div class="flex justify-center gap-2">
                <button
                  pButton
                  icon="pi pi-eye"
                  class="p-button-rounded p-button-text p-button-info"
                  pTooltip="Ver Detalle"
                  tooltipPosition="top"
                  (click)="verDetalle(periodo)"
                ></button>

                <button
                  pButton
                  icon="pi pi-file-pdf"
                  class="p-button-rounded p-button-text p-button-danger"
                  pTooltip="Exportar PDF"
                  tooltipPosition="top"
                  (click)="exportarPDF(periodo)"
                  [disabled]="!puedeModificar(periodo.estado)"
                ></button>

                <button
                  *ngIf="periodo.estado === 'Abierto'"
                  pButton
                  icon="pi pi-lock"
                  class="p-button-rounded p-button-text p-button-warning"
                  pTooltip="Cerrar Periodo"
                  tooltipPosition="top"
                  (click)="cerrarPeriodo(periodo)"
                ></button>

                <button
                  *ngIf="periodo.estado === 'Cerrado'"
                  pButton
                  icon="pi pi-check"
                  class="p-button-rounded p-button-text p-button-success"
                  pTooltip="Marcar como Facturado"
                  tooltipPosition="top"
                  (click)="facturarPeriodo(periodo)"
                ></button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="7" class="text-center py-4">No hay periodos disponibles</td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </div>
</div>
