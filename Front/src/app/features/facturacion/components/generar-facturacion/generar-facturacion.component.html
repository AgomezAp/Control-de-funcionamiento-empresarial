<div class="container mx-auto p-4 max-w-3xl">
  <p-toast></p-toast>

  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center gap-4 mb-4">
      <button
        pButton
        icon="pi pi-arrow-left"
        class="p-button-text p-button-rounded"
        (click)="volver()"
      ></button>
      <h2 class="text-3xl font-bold text-gray-800">
        <i class="pi pi-plus-circle text-green-600 mr-2"></i>
        Generar Facturación
      </h2>
    </div>
    <p class="text-gray-600 ml-14">
      Genera periodos de facturación para uno o varios clientes
    </p>
  </div>

  <!-- Formulario -->
  <p-card>
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Tipo de Generación -->
      <div class="mb-6">
        <label class="block text-sm font-semibold text-gray-700 mb-3">
          Tipo de Generación
        </label>
        <div class="flex gap-6">
          <div class="flex items-center cursor-pointer" (click)="tipoGeneracion = 'individual'; onTipoChange()">
            <input
              type="radio"
              name="tipoGeneracion"
              value="individual"
              [checked]="tipoGeneracion === 'individual'"
              id="individual"
              class="mr-2"
            />
            <label for="individual" class="cursor-pointer">
              <i class="pi pi-user text-blue-600"></i>
              Cliente Individual
            </label>
          </div>
          <div class="flex items-center cursor-pointer" (click)="tipoGeneracion = 'todos'; onTipoChange()">
            <input
              type="radio"
              name="tipoGeneracion"
              value="todos"
              [checked]="tipoGeneracion === 'todos'"
              id="todos"
              class="mr-2"
            />
            <label for="todos" class="cursor-pointer">
              <i class="pi pi-users text-green-600"></i>
              Todos los Clientes
            </label>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Cliente Individual -->
      <div *ngIf="tipoGeneracion === 'individual'" class="mb-6">
        <label for="cliente" class="block text-sm font-semibold text-gray-700 mb-2">
          Cliente <span class="text-red-500">*</span>
        </label>
        <p-dropdown
          id="cliente"
          formControlName="cliente_id"
          [options]="clientes"
          optionLabel="nombre"
          optionValue="id"
          placeholder="Seleccione un cliente"
          [filter]="true"
          filterBy="nombre,pais"
          [showClear]="true"
          [style]="{ width: '100%' }"
          [ngClass]="{ 'ng-invalid ng-dirty': isFieldInvalid('cliente_id') }"
        >
          <ng-template let-cliente pTemplate="item">
            <div class="flex items-center gap-2">
              <i class="pi pi-building text-gray-500"></i>
              <div>
                <div class="font-semibold">{{ cliente.nombre }}</div>
                <div class="text-xs text-gray-500">{{ cliente.pais }}</div>
              </div>
            </div>
          </ng-template>
        </p-dropdown>
        <small *ngIf="isFieldInvalid('cliente_id')" class="p-error block mt-1">
          {{ getErrorMessage('cliente_id') }}
        </small>
      </div>

      <!-- Mensaje para todos -->
      <div *ngIf="tipoGeneracion === 'todos'" class="mb-6">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
          <div class="flex items-start gap-3">
            <i class="pi pi-info-circle text-blue-600 text-xl"></i>
            <div>
              <p class="font-semibold text-blue-900 mb-1">Generación Masiva</p>
              <p class="text-sm text-blue-800">
                Se generará un periodo de facturación para <strong>todos los clientes activos</strong> 
                que tengan peticiones en el mes seleccionado.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Periodo -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label for="mes" class="block text-sm font-semibold text-gray-700 mb-2">
            Mes <span class="text-red-500">*</span>
          </label>
          <p-dropdown
            id="mes"
            formControlName="mes"
            [options]="meses"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccione el mes"
            [style]="{ width: '100%' }"
            [ngClass]="{ 'ng-invalid ng-dirty': isFieldInvalid('mes') }"
          ></p-dropdown>
          <small *ngIf="isFieldInvalid('mes')" class="p-error block mt-1">
            {{ getErrorMessage('mes') }}
          </small>
        </div>

        <div>
          <label for="año" class="block text-sm font-semibold text-gray-700 mb-2">
            Año <span class="text-red-500">*</span>
          </label>
          <p-dropdown
            id="año"
            formControlName="año"
            [options]="anios"
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccione el año"
            [style]="{ width: '100%' }"
            [ngClass]="{ 'ng-invalid ng-dirty': isFieldInvalid('año') }"
          ></p-dropdown>
          <small *ngIf="isFieldInvalid('año')" class="p-error block mt-1">
            {{ getErrorMessage('año') }}
          </small>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Vista previa -->
      <div class="mb-6 bg-gray-50 p-4 rounded-lg">
        <h3 class="font-semibold text-gray-700 mb-3 flex items-center gap-2">
          <i class="pi pi-eye text-blue-600"></i>
          Vista Previa
        </h3>
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span class="text-gray-600">Tipo:</span>
            <span class="font-semibold">
              {{ tipoGeneracion === 'individual' ? 'Cliente Individual' : 'Todos los Clientes' }}
            </span>
          </div>
          <div *ngIf="tipoGeneracion === 'individual' && form.value.cliente_id" class="flex justify-between">
            <span class="text-gray-600">Cliente:</span>
            <span class="font-semibold">
              {{ getSelectedCliente() }}
            </span>
          </div>
          <div class="flex justify-between">
            <span class="text-gray-600">Periodo:</span>
            <span class="font-semibold">
              {{ form.value.mes ? meses[form.value.mes - 1].label : '-' }} {{ anioSeleccionado || '-' }}
            </span>
          </div>
        </div>
      </div>

      <!-- Advertencia -->
      <div class="mb-6 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded">
        <div class="flex items-start gap-3">
          <i class="pi pi-exclamation-triangle text-yellow-600 text-xl"></i>
          <div>
            <p class="font-semibold text-yellow-900 mb-1">Importante</p>
            <p class="text-sm text-yellow-800">
              Si ya existe un periodo de facturación para este cliente y periodo, 
              se actualizarán los datos con la información más reciente.
            </p>
          </div>
        </div>
      </div>

      <!-- Botones -->
      <div class="flex justify-end gap-3">
        <button
          pButton
          type="button"
          label="Cancelar"
          icon="pi pi-times"
          class="p-button-outlined"
          (click)="volver()"
          [disabled]="loading"
        ></button>
        <button
          pButton
          type="submit"
          label="Generar Facturación"
          icon="pi pi-check"
          class="p-button-success"
          [loading]="loading"
        ></button>
      </div>
    </form>
  </p-card>
</div>
