<div class="generar-facturacion-container">
  <p-toast></p-toast>

  <!-- Header Compacto -->
  <div class="page-header">
    <button
      pButton
      icon="pi pi-arrow-left"
      class="btn-back"
      (click)="volver()"
      pTooltip="Volver"
      tooltipPosition="right"
    ></button>
    <div class="header-content">
      <div class="header-title">
        <i class="pi pi-plus-circle"></i>
        <h2>Generar Facturación</h2>
      </div>
      <p class="header-subtitle">
        Genera periodos de facturación para uno o varios clientes
      </p>
    </div>
  </div>

  <!-- Formulario Compacto -->
  <div class="form-card">
    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <!-- Grid Principal -->
      <div class="form-grid">
        <!-- Columna Izquierda: Tipo y Cliente -->
        <div class="form-column column-left">
          <!-- Tipo de Generación -->
          <div class="form-section compact">
            <label class="section-label">
              <i class="pi pi-cog"></i>
              Tipo de Generación
            </label>
            <div class="radio-group-compact">
              <div
                class="radio-option-compact"
                [class.selected]="tipoGeneracion === 'individual'"
                (click)="tipoGeneracion = 'individual'; onTipoChange()"
              >
                <input
                  type="radio"
                  name="tipoGeneracion"
                  value="individual"
                  [checked]="tipoGeneracion === 'individual'"
                  id="individual"
                />
                <i class="pi pi-user"></i>
                <div class="radio-text-compact">
                  <span class="radio-title-compact">Cliente Individual</span>
                </div>
              </div>

              <div
                class="radio-option-compact"
                [class.selected]="tipoGeneracion === 'todos'"
                (click)="tipoGeneracion = 'todos'; onTipoChange()"
              >
                <input
                  type="radio"
                  name="tipoGeneracion"
                  value="todos"
                  [checked]="tipoGeneracion === 'todos'"
                  id="todos"
                />
                <i class="pi pi-users"></i>
                <div class="radio-text-compact">
                  <span class="radio-title-compact">Todos los Clientes</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Cliente Individual -->
          <div
            *ngIf="tipoGeneracion === 'individual'"
            class="form-section compact"
          >
            <label for="cliente" class="field-label">
              <i class="pi pi-building"></i>
              Cliente
              <span class="required">*</span>
            </label>
            <p-dropdown
              id="cliente"
              formControlName="cliente_id"
              [options]="clientes"
              optionLabel="nombre"
              optionValue="id"
              placeholder="Seleccione un cliente"
              [filter]="true"
              filterBy="nombre,pais,cedula"
              [showClear]="true"
              styleClass="custom-dropdown-field"
              [ngClass]="{ 'field-invalid': isFieldInvalid('cliente_id') }"
            >
              <ng-template let-cliente pTemplate="item">
                <div class="dropdown-item-compact">
                  <i class="pi pi-building"></i>
                  <div class="dropdown-item-info">
                    <span class="dropdown-item-name">{{ cliente.nombre }}</span>
                    <span class="dropdown-item-detail">
                      {{ cliente.pais }}
                      <span *ngIf="cliente.cedula" style="color: #6c757d; margin-left: 8px;">
                        • {{ cliente.cedula }}
                      </span>
                    </span>
                  </div>
                </div>
              </ng-template>
            </p-dropdown>
            <small *ngIf="isFieldInvalid('cliente_id')" class="field-error">
              <i class="pi pi-exclamation-circle"></i>
              {{ getErrorMessage("cliente_id") }}
            </small>
          </div>

          <!-- Mensaje para todos -->
          <div *ngIf="tipoGeneracion === 'todos'" class="form-section compact">
            <div class="info-banner-compact info-banner-blue">
              <i class="pi pi-info-circle"></i>
              <div class="info-content-compact">
                <strong>Generación Masiva:</strong>
                Se generará para todos los clientes activos del periodo.
              </div>
            </div>
          </div>
        </div>

        <!-- Columna Central: Periodo -->
        <div class="form-column column-center">
          <!-- Periodo -->
          <div class="form-section compact">
            <label class="section-label">
              <i class="pi pi-calendar"></i>
              Periodo de Facturación
            </label>

            <div class="field-wrapper">
              <label for="mes" class="field-label-compact">
                Mes <span class="required">*</span>
              </label>
              <p-dropdown
                id="mes"
                formControlName="mes"
                [options]="meses"
                optionLabel="label"
                optionValue="value"
                placeholder="Mes"
                styleClass="custom-dropdown-field"
                [ngClass]="{ 'field-invalid': isFieldInvalid('mes') }"
              ></p-dropdown>
              <small *ngIf="isFieldInvalid('mes')" class="field-error">
                <i class="pi pi-exclamation-circle"></i>
                {{ getErrorMessage("mes") }}
              </small>
            </div>

            <div class="field-wrapper">
              <label for="año" class="field-label-compact">
                Año <span class="required">*</span>
              </label>
              <p-dropdown
                id="año"
                formControlName="año"
                [options]="anios"
                optionLabel="label"
                optionValue="value"
                placeholder="Año"
                styleClass="custom-dropdown-field"
                [ngClass]="{ 'field-invalid': isFieldInvalid('año') }"
              ></p-dropdown>
              <small *ngIf="isFieldInvalid('año')" class="field-error">
                <i class="pi pi-exclamation-circle"></i>
                {{ getErrorMessage("año") }}
              </small>
            </div>
          </div>
        </div>

        <!-- Columna Derecha: Vista Previa -->
        <div class="form-column column-right">
          <!-- Vista previa -->
          <div class="preview-section-compact">
            <h3 class="preview-title-compact">
              <i class="pi pi-eye"></i>
              Vista Previa
            </h3>
            <div class="preview-content-compact">
              <div class="preview-item-compact">
                <i
                  [class]="
                    tipoGeneracion === 'individual'
                      ? 'pi pi-user'
                      : 'pi pi-users'
                  "
                ></i>
                <div class="preview-text">
                  <span class="preview-label-compact">Tipo</span>
                  <span class="preview-value-compact">
                    {{
                      tipoGeneracion === "individual" ? "Individual" : "Todos"
                    }}
                  </span>
                </div>
              </div>

              <div
                *ngIf="tipoGeneracion === 'individual' && form.value.cliente_id"
                class="preview-item-compact"
              >
                <i class="pi pi-building"></i>
                <div class="preview-text">
                  <span class="preview-label-compact">Cliente</span>
                  <span class="preview-value-compact">
                    {{ getSelectedCliente() }}
                  </span>
                </div>
              </div>

              <div class="preview-item-compact">
                <i class="pi pi-calendar"></i>
                <div class="preview-text">
                  <span class="preview-label-compact">Periodo</span>
                  <span class="preview-value-compact">
                    {{ form.value.mes ? meses[form.value.mes - 1].label : "-" }}
                    {{ anioSeleccionado || "-" }}
                  </span>
                </div>
              </div>
            </div>
          </div>

          <!-- Advertencia Compacta -->
          <div class="info-banner-compact info-banner-yellow">
            <i class="pi pi-exclamation-triangle"></i>
            <div class="info-content-compact">
              <strong>Importante:</strong>
              Los datos existentes serán actualizados.
            </div>
          </div>
        </div>
      </div>

      <!-- Botones -->
      <div class="form-actions-compact">
        <button
          pButton
          type="button"
          label="Cancelar"
          icon="pi pi-times"
          class="btn-cancel"
          (click)="volver()"
          [disabled]="loading"
        ></button>
        <button
          pButton
          type="submit"
          label="Generar Facturación"
          icon="pi pi-check"
          class="btn-submit"
          [loading]="loading"
        ></button>
      </div>
    </form>
  </div>
</div>
