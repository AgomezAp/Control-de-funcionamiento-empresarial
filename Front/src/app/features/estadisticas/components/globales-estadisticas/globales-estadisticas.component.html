<div class="estadisticas-globales-container">
  <p-toast></p-toast>

  <!-- Header con filtros -->
  <div class="page-header">
    <div class="header-content">
      <div class="header-title">
        <i class="pi pi-globe"></i>
        <h2>Estadísticas Globales</h2>
      </div>

      <div class="header-filters">
        <p-dropdown
          [options]="meses"
          [(ngModel)]="selectedMes"
          placeholder="Seleccionar mes"
          optionLabel="label"
          optionValue="value"
          (onChange)="onFiltroChange()"
          styleClass="custom-dropdown"
        ></p-dropdown>

        <p-dropdown
          [options]="anios"
          [(ngModel)]="selectedAnio"
          placeholder="Seleccionar año"
          optionLabel="label"
          optionValue="value"
          (onChange)="onFiltroChange()"
          styleClass="custom-dropdown"
        ></p-dropdown>

        <button
          pButton
          icon="pi pi-refresh"
          label="Actualizar"
          (click)="loadEstadisticas()"
          [loading]="loading"
          class="btn-refresh"
        ></button>
      </div>
    </div>
  </div>

  <!-- Skeleton Loading -->
  <div *ngIf="loading" class="stats-grid">
    <div *ngFor="let i of [1, 2, 3, 4]" class="stat-card skeleton-card">
      <p-skeleton width="100%" height="150px" borderRadius="12px"></p-skeleton>
    </div>
  </div>

  <!-- Mensaje sin datos -->
  <div *ngIf="!loading && !estadisticasGlobales" class="empty-state">
    <div class="empty-state-content">
      <i class="pi pi-info-circle"></i>
      <h3>Sin datos disponibles</h3>
      <p>No hay estadísticas globales para el período seleccionado</p>
    </div>
  </div>

  <!-- Cards de totales -->
  <div *ngIf="!loading && estadisticasGlobales" class="stats-grid">
    <!-- Total Peticiones -->
    <div class="stat-card card-blue">
      <div class="stat-icon">
        <i class="pi pi-file"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Total Peticiones</p>
        <p class="stat-value">
          {{ estadisticasGlobales.totales.total_peticiones_creadas }}
        </p>
      </div>
      <div class="stat-decoration"></div>
    </div>

    <!-- Resueltas -->
    <div class="stat-card card-green">
      <div class="stat-icon">
        <i class="pi pi-check-circle"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Resueltas</p>
        <p class="stat-value">
          {{ estadisticasGlobales.totales.total_peticiones_resueltas }}
        </p>
        <p class="stat-subtitle">
          {{
            calcularPorcentaje(
              estadisticasGlobales.totales.total_peticiones_resueltas,
              estadisticasGlobales.totales.total_peticiones_creadas
            )
          }}% efectividad
        </p>
      </div>
      <div class="stat-decoration"></div>
    </div>

    <!-- Canceladas -->
    <div class="stat-card card-red">
      <div class="stat-icon">
        <i class="pi pi-times-circle"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Canceladas</p>
        <p class="stat-value">
          {{ estadisticasGlobales.totales.total_peticiones_canceladas }}
        </p>
      </div>
      <div class="stat-decoration"></div>
    </div>

    <!-- Tiempo Promedio -->
    <div class="stat-card card-yellow">
      <div class="stat-icon">
        <i class="pi pi-clock"></i>
      </div>
      <div class="stat-content">
        <p class="stat-label">Tiempo Promedio</p>
        <p class="stat-value">
          {{
            estadisticasGlobales.totales.promedio_tiempo_resolucion
              | number : "1.1-1"
          }}
        </p>
        <p class="stat-subtitle">horas</p>
      </div>
      <div class="stat-decoration"></div>
    </div>
  </div>

  <!-- Costo Total (Destacado) -->
  <div *ngIf="!loading && estadisticasGlobales" class="cost-card-wrapper">
    <div class="cost-card">
      <div class="cost-icon">
        <i class="pi pi-dollar"></i>
      </div>
      <div class="cost-content">
        <p class="cost-label">Costo Total Generado</p>
        <p class="cost-value">
          ${{
            estadisticasGlobales.totales.total_costo_generado | number : "1.2-2"
          }}
        </p>
      </div>
      <div class="cost-decoration">
        <div class="decoration-circle circle-1"></div>
        <div class="decoration-circle circle-2"></div>
        <div class="decoration-circle circle-3"></div>
      </div>
    </div>
  </div>

  <!-- Gráficos -->
  <div *ngIf="!loading && estadisticasGlobales" class="charts-grid">
    <!-- Gráfico por áreas -->
    <div class="chart-card">
      <div class="chart-header">
        <i class="pi pi-chart-bar"></i>
        <h3>Rendimiento por Área</h3>
      </div>
      <div class="chart-content">
        <p-chart
          type="bar"
          [data]="chartDataAreas"
          [options]="chartOptions"
        ></p-chart>
      </div>
    </div>

    <!-- Gráfico top usuarios -->
    <div class="chart-card">
      <div class="chart-header">
        <i class="pi pi-users"></i>
        <h3>Top 10 Usuarios</h3>
      </div>
      <div class="chart-content">
        <p-chart
          type="bar"
          [data]="chartDataUsuarios"
          [options]="chartOptions"
        ></p-chart>
      </div>
    </div>
  </div>

  <!-- Tabla por áreas -->
  <div
    *ngIf="!loading && estadisticasGlobales && estadisticasGlobales.por_area"
    class="table-card"
  >
    <div class="table-header">
      <i class="pi pi-building"></i>
      <h3>Detalle por Área</h3>
    </div>

    <div class="table-content">
      <p-table
        [value]="estadisticasGlobales.por_area"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} áreas"
        styleClass="custom-table"
        [rowHover]="true"
      >
        <ng-template pTemplate="header">
          <tr>
            <th pSortableColumn="area">
              <div class="th-content">
                <span>Área</span>
                <p-sortIcon field="area"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="peticiones_creadas" class="text-center">
              <div class="th-content">
                <span>Creadas</span>
                <p-sortIcon field="peticiones_creadas"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="peticiones_resueltas" class="text-center">
              <div class="th-content">
                <span>Resueltas</span>
                <p-sortIcon field="peticiones_resueltas"></p-sortIcon>
              </div>
            </th>
            <th class="text-center">Efectividad</th>
            <th pSortableColumn="costo_total" class="text-right">
              <div class="th-content">
                <span>Costo Total</span>
                <p-sortIcon field="costo_total"></p-sortIcon>
              </div>
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-area>
          <tr>
            <td>
              <div class="cell-with-icon">
                <i class="pi pi-building"></i>
                <span class="cell-text-bold">{{ area.area }}</span>
              </div>
            </td>
            <td class="text-center">
              <span class="badge badge-blue">{{
                area.peticiones_creadas
              }}</span>
            </td>
            <td class="text-center">
              <span class="badge badge-green">{{
                area.peticiones_resueltas
              }}</span>
            </td>
            <td class="text-center">
              <p-tag
                [value]="area.efectividad + '%'"
                [severity]="getAreaSeverity(area)"
                styleClass="custom-tag"
              ></p-tag>
            </td>
            <td class="text-right">
              <span class="cell-amount"
                >${{ area.costo_total | number : "1.2-2" }}</span
              >
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="5">
              <div class="empty-table">
                <i class="pi pi-inbox"></i>
                <p>No hay datos disponibles</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>

  <!-- Tabla top usuarios -->
  <div
    *ngIf="!loading && estadisticasGlobales && estadisticasGlobales.por_usuario"
    class="table-card"
  >
    <div class="table-header">
      <i class="pi pi-star"></i>
      <h3>Ranking de Usuarios</h3>
    </div>

    <div class="table-content">
      <p-table
        [value]="estadisticasGlobales.por_usuario"
        [paginator]="true"
        [rows]="10"
        [showCurrentPageReport]="true"
        currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} usuarios"
        styleClass="custom-table"
        [rowHover]="true"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="text-center ranking-col">#</th>
            <th pSortableColumn="usuario.nombre_completo">
              <div class="th-content">
                <span>Usuario</span>
                <p-sortIcon field="usuario.nombre_completo"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="peticiones_creadas" class="text-center">
              <div class="th-content">
                <span>Creadas</span>
                <p-sortIcon field="peticiones_creadas"></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="peticiones_resueltas" class="text-center">
              <div class="th-content">
                <span>Resueltas</span>
                <p-sortIcon field="peticiones_resueltas"></p-sortIcon>
              </div>
            </th>
            <th
              pSortableColumn="tiempo_promedio_resolucion_horas"
              class="text-center"
            >
              <div class="th-content">
                <span>Tiempo Prom.</span>
                <p-sortIcon
                  field="tiempo_promedio_resolucion_horas"
                ></p-sortIcon>
              </div>
            </th>
            <th pSortableColumn="costo_total_generado" class="text-right">
              <div class="th-content">
                <span>Costo Total</span>
                <p-sortIcon field="costo_total_generado"></p-sortIcon>
              </div>
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-usuario let-rowIndex="rowIndex">
          <tr>
            <td class="text-center">
              <div
                class="ranking-badge"
                [ngClass]="{
                  'rank-1': rowIndex === 0,
                  'rank-2': rowIndex === 1,
                  'rank-3': rowIndex === 2
                }"
              >
                <span>{{ rowIndex + 1 }}</span>
              </div>
            </td>
            <td>
              <div class="cell-with-icon">
                <i class="pi pi-user"></i>
                <span class="cell-text-bold">{{
                  usuario.nombre_completo || "Usuario desconocido"
                }}</span>
              </div>
            </td>
            <td class="text-center">
              <span class="badge badge-blue">{{
                usuario.peticiones_creadas
              }}</span>
            </td>
            <td class="text-center">
              <span class="badge badge-green">{{
                usuario.peticiones_resueltas
              }}</span>
            </td>
            <td class="text-center">
              <span class="badge badge-yellow">
                {{
                  usuario.tiempo_promedio_resolucion_horas || 0
                    | number : "1.1-1"
                }}
                hrs
              </span>
            </td>
            <td class="text-right">
              <span class="cell-amount"
                >${{ usuario.costo_total_generado | number : "1.2-2" }}</span
              >
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6">
              <div class="empty-table">
                <i class="pi pi-inbox"></i>
                <p>No hay datos disponibles</p>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>
