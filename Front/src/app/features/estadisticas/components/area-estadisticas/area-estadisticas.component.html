<div class="container">
  <!-- Toast personalizado -->
  <div class="toast-container" *ngIf="showToast">
    <div
      class="toast"
      [class.success]="toastType === 'success'"
      [class.error]="toastType === 'error'"
    >
      <i
        class="icon"
        [class.icon-check]="toastType === 'success'"
        [class.icon-error]="toastType === 'error'"
      ></i>
      <span>{{ toastMessage }}</span>
      <button class="toast-close" (click)="showToast = false">×</button>
    </div>
  </div>

  <!-- Header con filtros -->
  <div class="header-section">
    <div class="header-wrapper">
      <h2 class="page-title">
        <i class="icon-building"></i>
        Estadísticas por Área
      </h2>

      <div class="filters-container">
        <!-- Selector de Área (solo para Admin/Directivo) -->
        <div class="select-wrapper" *ngIf="esAdmin">
          <select
            class="custom-select"
            [(ngModel)]="areaSeleccionada"
            (change)="onAreaChange()"
          >
            <option value="" disabled>Seleccionar Área</option>
            <option *ngFor="let area of areasDisponibles" [value]="area.value">
              {{ area.label }}
            </option>
          </select>
          <i class="select-icon icon-chevron-down"></i>
        </div>

        <!-- Mostrar área fija si no es Admin/Directivo -->
        <div *ngIf="!esAdmin" class="area-badge">
          <i class="icon-building"></i>
          <span>{{ areaSeleccionada }}</span>
        </div>

        <div class="select-wrapper">
          <select
            class="custom-select"
            [(ngModel)]="selectedMes"
            (change)="onFiltroChange()"
          >
            <option value="" disabled>Mes</option>
            <option *ngFor="let mes of meses" [value]="mes.value">
              {{ mes.label }}
            </option>
          </select>
          <i class="select-icon icon-chevron-down"></i>
        </div>

        <div class="select-wrapper">
          <select
            class="custom-select"
            [(ngModel)]="selectedAnio"
            (change)="onFiltroChange()"
          >
            <option value="" disabled>Año</option>
            <option *ngFor="let anio of anios" [value]="anio.value">
              {{ anio.label }}
            </option>
          </select>
          <i class="select-icon icon-chevron-down"></i>
        </div>

        <button
          class="btn btn-refresh"
          (click)="loadEstadisticas()"
          [disabled]="loading"
        >
          <i class="icon-refresh" [class.spinning]="loading"></i>
          <span>Actualizar</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Resumen del Área -->
  <div *ngIf="!loading && estadisticas.length > 0" class="stats-grid">
    <div class="stat-card stat-creadas">
      <div class="stat-content">
        <p class="stat-label">Total Creadas</p>
        <p class="stat-value">{{ resumenArea.totalCreadas }}</p>
      </div>
    </div>

    <div class="stat-card stat-resueltas">
      <div class="stat-content">
        <p class="stat-label">Total Resueltas</p>
        <p class="stat-value">{{ resumenArea.totalResueltas }}</p>
        <p class="stat-percentage">
          {{
            calcularPorcentaje(
              resumenArea.totalResueltas,
              resumenArea.totalCreadas
            )
          }}%
        </p>
      </div>
    </div>

    <div class="stat-card stat-canceladas">
      <div class="stat-content">
        <p class="stat-label">Total Canceladas</p>
        <p class="stat-value">{{ resumenArea.totalCanceladas }}</p>
      </div>
    </div>

    <div class="stat-card stat-tiempo">
      <div class="stat-content">
        <p class="stat-label">Tiempo Promedio</p>
        <p class="stat-value">
          {{ resumenArea.promedioTiempo | number : "1.1-1" }}
        </p>
        <p class="stat-unit">horas</p>
      </div>
    </div>

    <div class="stat-card stat-costo">
      <div class="stat-content">
        <p class="stat-label">Costo Total</p>
        <p class="stat-value-currency">
          ${{ resumenArea.costoTotal | number : "1.2-2" }}
        </p>
      </div>
    </div>
  </div>

  <!-- Skeleton Loading -->
  <div *ngIf="loading" class="loading-container">
    <div class="card">
      <div class="skeleton skeleton-chart"></div>
    </div>
    <div class="card">
      <div class="skeleton skeleton-table"></div>
    </div>
  </div>

  <!-- Mensaje sin datos -->
  <div *ngIf="!loading && estadisticas.length === 0" class="empty-state">
    <div class="card">
      <i class="icon-info"></i>
      <h3>Sin datos disponibles</h3>
      <p>No hay estadísticas para este área en el período seleccionado</p>
    </div>
  </div>

  <!-- Gráfico comparativo -->
  <div *ngIf="!loading && estadisticas.length > 0" class="chart-section">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Comparación de Usuarios del Área</h3>
      </div>
      <div class="card-body">
        <div class="chart-container">
          <canvas #chartCanvas></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabla detallada -->
  <div *ngIf="!loading && estadisticas.length > 0" class="table-section">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">Detalle por Usuario</h3>
      </div>

      <div class="table-responsive">
        <table class="custom-table">
          <thead>
            <tr>
              <th (click)="sortBy('usuario.nombre_completo')" class="sortable">
                Usuario
                <i
                  class="sort-icon"
                  [class.active]="sortField === 'usuario.nombre_completo'"
                ></i>
              </th>
              <th
                (click)="sortBy('peticiones_creadas')"
                class="sortable text-center"
              >
                Creadas
                <i
                  class="sort-icon"
                  [class.active]="sortField === 'peticiones_creadas'"
                ></i>
              </th>
              <th
                (click)="sortBy('peticiones_resueltas')"
                class="sortable text-center"
              >
                Resueltas
                <i
                  class="sort-icon"
                  [class.active]="sortField === 'peticiones_resueltas'"
                ></i>
              </th>
              <th class="text-center">% Efectividad</th>
              <th
                (click)="sortBy('peticiones_canceladas')"
                class="sortable text-center"
              >
                Canceladas
                <i
                  class="sort-icon"
                  [class.active]="sortField === 'peticiones_canceladas'"
                ></i>
              </th>
              <th
                (click)="sortBy('tiempo_promedio_resolucion_horas')"
                class="sortable text-center"
              >
                Tiempo Prom.
                <i
                  class="sort-icon"
                  [class.active]="
                    sortField === 'tiempo_promedio_resolucion_horas'
                  "
                ></i>
              </th>
              <th
                (click)="sortBy('costo_total_generado')"
                class="sortable text-right"
              >
                Costo Total
                <i
                  class="sort-icon"
                  [class.active]="sortField === 'costo_total_generado'"
                ></i>
              </th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let est of paginatedData">
              <td>
                <div class="user-cell">
                  <i class="icon-user"></i>
                  <span>{{
                    est.usuario?.nombre_completo || "Usuario " + est.usuario_id
                  }}</span>
                </div>
              </td>
              <td class="text-center">
                <span class="badge badge-neutral">{{
                  est.peticiones_creadas
                }}</span>
              </td>
              <td class="text-center">
                <span class="badge badge-success">{{
                  est.peticiones_resueltas
                }}</span>
              </td>
              <td class="text-center">
                <span
                  class="badge"
                  [ngClass]="
                    getBadgeClass(
                      calcularPorcentaje(
                        est.peticiones_resueltas,
                        est.peticiones_creadas
                      )
                    )
                  "
                >
                  {{
                    calcularPorcentaje(
                      est.peticiones_resueltas,
                      est.peticiones_creadas
                    )
                  }}%
                </span>
              </td>
              <td class="text-center">
                <span class="badge badge-danger">{{
                  est.peticiones_canceladas
                }}</span>
              </td>
              <td class="text-center">
                <span class="time-value">
                  {{
                    est.tiempo_promedio_resolucion_horas || 0 | number : "1.1-1"
                  }}
                  hrs
                </span>
              </td>
              <td class="text-right">
                <span class="cost-value">
                  ${{ est.costo_total_generado | number : "1.2-2" }}
                </span>
              </td>
            </tr>
          </tbody>
        </table>

        <div *ngIf="estadisticas.length === 0" class="empty-table">
          No hay datos disponibles
        </div>
      </div>

      <!-- Paginación -->
      <div class="pagination-container" *ngIf="estadisticas.length > 0">
        <div class="pagination-info">
          Mostrando {{ startIndex + 1 }} a {{ endIndex }} de
          {{ estadisticas.length }} usuarios
        </div>

        <div class="pagination-controls">
          <button
            class="btn-pagination"
            (click)="previousPage()"
            [disabled]="currentPage === 1"
          >
            <i class="icon-chevron-left"></i>
          </button>

          <span class="page-numbers">
            <button
              *ngFor="let page of getPageNumbers()"
              class="btn-page"
              [class.active]="page === currentPage"
              (click)="goToPage(page)"
            >
              {{ page }}
            </button>
          </span>

          <button
            class="btn-pagination"
            (click)="nextPage()"
            [disabled]="currentPage === totalPages"
          >
            <i class="icon-chevron-right"></i>
          </button>
        </div>

        <div class="rows-per-page">
          <label>Filas por página:</label>
          <select
            [(ngModel)]="rowsPerPage"
            (change)="onRowsPerPageChange()"
            class="select-small"
          >
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>
