<div class="peticiones-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <i class="pi pi-file-edit header-icon"></i>
      <h1 class="page-title">Peticiones</h1>
      <span class="count-badge">{{ peticiones.length }}</span>
    </div>
    <div class="header-actions">
      <button
        *appHasRole="[
          RoleEnum.ADMIN,
          RoleEnum.DIRECTIVO,
          RoleEnum.LIDER,
          RoleEnum.USUARIO
        ]"
        class="btn btn-primary"
        (click)="crearNueva()"
      >
        <i class="pi pi-plus"></i>
        Crear Nueva
      </button>
      <button
        class="btn btn-secondary"
        (click)="exportarPDF()"
        [disabled]="peticionesFiltradas.length === 0"
        pTooltip="Exportar lista a PDF"
        tooltipPosition="bottom"
      >
        <i class="pi pi-file-pdf"></i>
        PDF
      </button>
      <button
        class="btn btn-secondary"
        (click)="imprimirLista()"
        [disabled]="peticionesFiltradas.length === 0"
        pTooltip="Imprimir lista"
        tooltipPosition="bottom"
      >
        <i class="pi pi-print"></i>
        Imprimir
      </button>
      <button
        class="btn btn-icon"
        [class.active]="mostrarFiltros"
        (click)="mostrarFiltros = !mostrarFiltros"
      >
        <i class="pi pi-filter"></i>
        <span
          *ngIf="filtroEstado.length + (filtroCliente ? 1 : 0) > 0"
          class="filter-badge"
        >
          {{ filtroEstado.length + (filtroCliente ? 1 : 0) }}
        </span>
      </button>
      <button
        class="btn btn-icon"
        (click)="cambiarVista(vistaActual === 'tabla' ? 'cards' : 'tabla')"
      >
        <i
          [class]="vistaActual === 'tabla' ? 'pi pi-th-large' : 'pi pi-list'"
        ></i>
      </button>
    </div>
  </div>

  <!-- Panel de Filtros Compacto -->
  <div *ngIf="mostrarFiltros" class="filters-panel">
    <div class="filters-header">
      <div class="filters-title">
        <i class="pi pi-filter"></i>
        <h3>Filtros Avanzados</h3>
      </div>
      <button class="btn-close" (click)="mostrarFiltros = false">
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div class="filters-grid">
      <!-- Buscador -->
      <div class="filter-item">
        <label>
          <i class="pi pi-search"></i>
          Buscar
        </label>
        <div class="search-wrapper">
          <i class="pi pi-search search-icon"></i>
          <input
            type="text"
            class="filter-input"
            [(ngModel)]="searchTerm"
            placeholder="ID, cliente, descripción..."
          />
        </div>
      </div>

      <!-- Filtro Estado -->
      <div class="filter-item">
        <label>
          <i class="pi pi-tag"></i>
          Estado
        </label>
        <p-multiSelect
          [options]="estadosOptions"
          [(ngModel)]="filtroEstado"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos los estados"
          [showClear]="true"
          styleClass="filter-multiselect"
        ></p-multiSelect>
      </div>

      <!-- Filtro Cliente -->
      <div class="filter-item">
        <label>
          <i class="pi pi-building"></i>
          Cliente
        </label>
        <p-dropdown
          [options]="clientes"
          [(ngModel)]="filtroCliente"
          optionLabel="nombre"
          optionValue="id"
          placeholder="Todos los clientes"
          [showClear]="true"
          [filter]="true"
          filterBy="nombre"
          styleClass="filter-dropdown"
        ></p-dropdown>
      </div>

      <!-- Filtro Fecha -->
      <div class="filter-item full-width">
        <label>
          <i class="pi pi-calendar"></i>
          Rango de Fechas
        </label>
        <div class="date-range">
          <p-calendar
            [(ngModel)]="filtroFechaInicio"
            placeholder="Desde"
            [showIcon]="true"
            dateFormat="dd/mm/yy"
            styleClass="filter-calendar"
          ></p-calendar>
          <span class="date-separator">→</span>
          <p-calendar
            [(ngModel)]="filtroFechaFin"
            placeholder="Hasta"
            [showIcon]="true"
            dateFormat="dd/mm/yy"
            styleClass="filter-calendar"
          ></p-calendar>
        </div>
      </div>
    </div>

    <!-- Botones de Filtros -->
    <div class="filters-actions">
      <button class="btn btn-secondary" (click)="limpiarFiltros()">
        <i class="pi pi-filter-slash"></i>
        Limpiar
      </button>
      <button class="btn btn-primary" (click)="aplicarFiltros()">
        <i class="pi pi-check"></i>
        Aplicar Filtros
      </button>
    </div>
  </div>

  <!-- Loading -->
  <app-loader *ngIf="loading"></app-loader>

  <!-- Vista Tabla -->
  <div *ngIf="!loading && vistaActual === 'tabla'" class="table-container">
    <div class="table-wrapper">
      <table class="peticiones-table">
        <!-- Header -->
        <thead>
          <tr>
            <th class="col-checkbox">
              <input type="checkbox" class="table-checkbox" />
            </th>
            <th class="col-id">ID</th>
            <th class="col-cliente">Cliente</th>
            <th class="col-categoria">Categoría</th>
            <th class="col-costo">Costo</th>
            <th class="col-estado">Estado</th>
            <th class="col-fecha">Creado</th>
            <th class="col-acciones">Acciones</th>
          </tr>
        </thead>

        <!-- Body -->
        <tbody>
          <tr *ngFor="let peticion of peticionesFiltradas" class="table-row">
            <!-- Checkbox -->
            <td>
              <input type="checkbox" class="table-checkbox" />
            </td>

            <!-- ID -->
            <td>
              <span class="id-badge" [appTooltip]="'Petición ID: ' + peticion.id">#{{ peticion.id }}</span>
            </td>

            <!-- Cliente -->
            <td>
              <div class="cliente-cell">
                <div class="avatar" [appTooltip]="peticion.cliente?.nombre || 'Sin cliente'">
                  {{ peticion.cliente?.nombre | initials }}
                </div>
                <span class="cliente-name" [innerHTML]="(peticion.cliente?.nombre || '') | highlight: searchTerm"></span>
              </div>
            </td>

            <!-- Categoría -->
            <td>
              <div class="categoria-cell">
                <span class="categoria-name" [innerHTML]="(peticion.categoria?.nombre || '') | highlight: searchTerm"></span>
                <span class="area-badge" [appTooltip]="'Área: ' + peticion.categoria?.area_tipo">
                  <i class="pi pi-briefcase"></i>
                  {{ peticion.categoria?.area_tipo }}
                </span>
              </div>
            </td>

            <!-- Costo -->
            <td>
              <span class="costo-value">{{
                peticion.costo | currencyCop
              }}</span>
            </td>

            <!-- Estado -->
            <td>
              <div class="estado-cell">
                <span
                  [class]="
                    'status-badge status-' +
                    peticion.estado.toLowerCase().replace(' ', '-')
                  "
                >
                  <i [class]="'pi ' + getStatusIcon(peticion.estado)"></i>
                  {{ peticion.estado }}
                </span>
                <div
                  *ngIf="peticion.estado === 'En Progreso'"
                  class="tiempo-empleado-badge"
                >
                  <i class="pi pi-clock"></i>
                  {{ formatearTiempo(peticion.tiempo_empleado_actual || peticion.tiempo_empleado_segundos || 0) }}
                </div>
              </div>
            </td>

            <!-- Fecha -->
            <td>
              <div class="fecha-cell">
                <span class="fecha-value">
                  <i class="pi pi-clock"></i>
                  {{ peticion.fecha_creacion | timeAgo }}
                </span>
                <span class="creador-name"
                  >por {{ peticion.creador?.nombre_completo }}</span
                >
              </div>
            </td>

            <!-- Acciones -->
            <td>
              <div class="actions-cell">
                <button
                  class="action-btn view-btn"
                  (click)="verDetalle(peticion.id)"
                  pTooltip="Ver detalle"
                  tooltipPosition="top"
                >
                  <i class="pi pi-eye"></i>
                </button>
                <button
                  class="action-btn pdf-btn"
                  (click)="exportarPeticionPDF(peticion)"
                  pTooltip="Exportar a PDF"
                  tooltipPosition="top"
                >
                  <i class="pi pi-file-pdf"></i>
                </button>
                <button
                  class="action-btn print-btn"
                  (click)="imprimirPeticion(peticion)"
                  pTooltip="Imprimir"
                  tooltipPosition="top"
                >
                  <i class="pi pi-print"></i>
                </button>
                <!-- Botones pausar/reanudar temporizador -->
                <button
                  *ngIf="peticion.estado === 'En Progreso' && canPauseOrResume(peticion) && peticion.temporizador_activo"
                  class="action-btn pause-btn"
                  (click)="pausarTemporizador(peticion)"
                  pTooltip="Pausar temporizador"
                  tooltipPosition="top"
                  [disabled]="loadingAccion"
                >
                  <i class="pi pi-pause"></i>
                </button>
                <button
                  *ngIf="peticion.estado === 'Pausada' && canPauseOrResume(peticion)"
                  class="action-btn resume-btn"
                  (click)="reanudarTemporizador(peticion)"
                  pTooltip="Reanudar temporizador"
                  tooltipPosition="top"
                  [disabled]="loadingAccion"
                >
                  <i class="pi pi-play"></i>
                </button>
                <button
                  *ngIf="canAcceptPeticion(peticion)"
                  class="action-btn accept-btn"
                  (click)="aceptarPeticion(peticion)"
                  pTooltip="Aceptar"
                  tooltipPosition="top"
                >
                  <i class="pi pi-check"></i>
                </button>
                <button
                  *ngIf="
                    canCancelPeticion(peticion) &&
                    peticion.estado !== 'Cancelada'
                  "
                  class="action-btn cancel-btn"
                  (click)="cancelarPeticion(peticion)"
                  pTooltip="Cancelar"
                  tooltipPosition="top"
                >
                  <i class="pi pi-times"></i>
                </button>
              </div>
            </td>
          </tr>

          <!-- Empty State -->
          <tr *ngIf="peticionesFiltradas.length === 0">
            <td colspan="8" class="empty-cell">
              <app-empty-state
                icon="pi-file-edit"
                title="No hay peticiones"
                message="No se encontraron peticiones"
              ></app-empty-state>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="pagination" *ngIf="peticionesFiltradas.length > 0">
      <div class="pagination-info">
        Mostrando {{ peticionesFiltradas.length }} de
        {{ peticiones.length }} peticiones
      </div>
      <div class="pagination-controls">
        <button class="pagination-btn">
          <i class="pi pi-angle-double-left"></i>
        </button>
        <button class="pagination-btn">
          <i class="pi pi-angle-left"></i>
        </button>
        <button class="pagination-btn active">1</button>
        <button class="pagination-btn">2</button>
        <button class="pagination-btn">3</button>
        <button class="pagination-btn">
          <i class="pi pi-angle-right"></i>
        </button>
        <button class="pagination-btn">
          <i class="pi pi-angle-double-right"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Vista Cards -->
  <div *ngIf="!loading && vistaActual === 'cards'" class="cards-grid">
    <div *ngFor="let peticion of peticionesFiltradas" class="peticion-card">
      <!-- Card Header -->
      <div class="card-header-custom">
        <span class="card-id" [appTooltip]="'Petición ID: ' + peticion.id">#{{ peticion.id }}</span>
        <span
          [class]="
            'status-badge status-' +
            peticion.estado.toLowerCase().replace(' ', '-')
          "
          [appTooltip]="'Estado: ' + peticion.estado"
        >
          <i [class]="'pi ' + getStatusIcon(peticion.estado)"></i>
          {{ peticion.estado }}
        </span>
      </div>

      <!-- Card Body -->
      <div class="card-body-custom">
        <div class="card-info-item">
          <i class="pi pi-building"></i>
          <span [innerHTML]="(peticion.cliente?.nombre || '') | highlight: searchTerm"></span>
        </div>

        <div class="card-info-item">
          <i class="pi pi-tag"></i>
          <span [innerHTML]="(peticion.categoria?.nombre || '') | highlight: searchTerm"></span>
          <span class="area-badge-small" [appTooltip]="'Área: ' + peticion.categoria?.area_tipo">{{
            peticion.categoria?.area_tipo
          }}</span>
        </div>

        <div class="card-info-item description">
          <i class="pi pi-align-left"></i>
          <p [innerHTML]="((peticion.descripcion || '') | truncate : 100) | highlight: searchTerm"></p>
        </div>

        <div class="card-info-item cost">
          <i class="pi pi-money-bill"></i>
          <span class="cost-amount">{{ peticion.costo | currencyCop }}</span>
        </div>

        <div *ngIf="peticion.estado === 'En Progreso'" class="card-time-employed">
          <i class="pi pi-clock"></i>
          <span>Tiempo: {{ formatearTiempo(peticion.tiempo_empleado_actual || peticion.tiempo_empleado_segundos || 0) }}</span>
          <span *ngIf="peticion.temporizador_activo" class="active-indicator">●</span>
        </div>

        <div class="card-info-item timestamp">
          <i class="pi pi-clock"></i>
          <span>{{ peticion.fecha_creacion | timeAgo }}</span>
        </div>
      </div>

      <!-- Card Footer -->
      <div class="card-footer-custom">
        <button class="card-btn btn-outline" (click)="verDetalle(peticion.id)">
          <i class="pi pi-eye"></i>
          Ver
        </button>
        <button class="card-btn btn-outline" (click)="exportarPeticionPDF(peticion)">
          <i class="pi pi-file-pdf"></i>
          PDF
        </button>
        <button class="card-btn btn-outline" (click)="imprimirPeticion(peticion)">
          <i class="pi pi-print"></i>
          Imprimir
        </button>
        <!-- Botones pausar/reanudar -->
        <button
          *ngIf="peticion.estado === 'En Progreso' && canPauseOrResume(peticion) && peticion.temporizador_activo"
          class="card-btn btn-warning"
          (click)="pausarTemporizador(peticion)"
          [disabled]="loadingAccion"
        >
          <i class="pi pi-pause"></i>
          Pausar
        </button>
        <button
          *ngIf="peticion.estado === 'Pausada' && canPauseOrResume(peticion)"
          class="card-btn btn-success"
          (click)="reanudarTemporizador(peticion)"
          [disabled]="loadingAccion"
        >
          <i class="pi pi-play"></i>
          Reanudar
        </button>
        <button
          *ngIf="canAcceptPeticion(peticion)"
          class="card-btn btn-success"
          (click)="aceptarPeticion(peticion)"
        >
          <i class="pi pi-check"></i>
          Aceptar
        </button>
      </div>
    </div>

    <!-- Empty State Cards -->
    <div *ngIf="peticionesFiltradas.length === 0" class="empty-cards">
      <app-empty-state
        icon="pi-file-edit"
        title="No hay peticiones"
        message="No se encontraron peticiones"
      ></app-empty-state>
    </div>
  </div>
</div>

<p-confirmDialog></p-confirmDialog>
<p-toast></p-toast>
