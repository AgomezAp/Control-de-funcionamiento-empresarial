<div class="crear-peticion-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <i class="pi pi-plus-circle header-icon"></i>
      <h2 class="page-title">Crear Nueva Petición</h2>
    </div>
    <button 
      class="btn btn-cancel" 
      (click)="cancelar()"
      pTooltip="Cancelar y salir sin guardar"
      tooltipPosition="bottom"
    >
      <i class="pi pi-times"></i>
      Cancelar
    </button>
  </div>

  <!-- Steps -->
  <div class="steps-container">
    <div class="custom-steps">
      <div
        class="step-item"
        *ngFor="let item of items; let i = index"
        [class.active]="i === activeIndex"
        [class.completed]="i < activeIndex"
      >
        <div class="step-circle">
          <i [class]="item.icon"></i>
        </div>
        <span class="step-label">{{ item.label }}</span>
        <div class="step-line" *ngIf="i < items.length - 1"></div>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <app-loader *ngIf="loading"></app-loader>

  <!-- Contenido Principal -->
  <div class="peticion-content" *ngIf="!loading">
    <!-- PASO 1: Seleccionar Cliente -->
    <div *ngIf="activeIndex === 0" class="step-content">
      <form [formGroup]="formCliente" class="step-form">
        <div class="form-field">
          <label for="cliente_id" class="form-label">
            <i class="pi pi-building"></i>
            Seleccionar Cliente
            <span class="required">*</span>
          </label>
          <select
            id="cliente_id"
            formControlName="cliente_id"
            class="form-select"
            (change)="onClienteChange($event)"
          >
            <option value="">Seleccione un cliente</option>
            <option *ngFor="let cliente of clientes" [value]="cliente.id">
              {{ cliente.nombre }}
            </option>
          </select>
        </div>

        <!-- Info del Cliente Seleccionado -->
        <div *ngIf="clienteSeleccionado" class="info-box">
          <div class="info-box-header">
            <i class="pi pi-info-circle"></i>
            <h4>Información del Cliente</h4>
          </div>
          <div class="info-box-content">
            <div class="info-item">
              <span class="info-label">Nombre:</span>
              <span class="info-value">{{ clienteSeleccionado.nombre }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">País:</span>
              <span class="info-value">{{ clienteSeleccionado.pais }}</span>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- PASO 2: Seleccionar Categoría -->
    <div *ngIf="activeIndex === 1" class="step-content">
      <form [formGroup]="formCategoria" class="step-form">
        <!-- Seleccionar Área (visible para Admin, Pautas y Diseño) -->
        <div class="form-field" *ngIf="mostrarSelectArea">
          <label for="area" class="form-label">
            <i class="pi pi-briefcase"></i>
            Área
            <span class="required">*</span>
          </label>
          <select id="area" formControlName="area" class="form-select" (change)="onAreaChange($event)">
            <option value="">Seleccione el área</option>
            <option value="Diseño">Diseño</option>
            <option value="Pautas">Pautas</option>
            <!-- Solo Admin puede seleccionar Gestión Administrativa -->
            <option value="Gestión Administrativa" *ngIf="currentUser?.rol === 'Admin'">Gestión Administrativa</option>
          </select>
          <small
            class="form-hint"
            *ngIf="formCategoria.value.area === 'Pautas'"
          >
            <i class="pi pi-info-circle"></i>
            Las peticiones de Pautas se asignan automáticamente al pautador del
            cliente
          </small>
        </div>

        <!-- Mensaje informativo cuando el área está fija -->
        <div class="form-field" *ngIf="!mostrarSelectArea">
          <div class="info-message">
            <i class="pi pi-info-circle"></i>
            <span>Creando petición para el área de <strong>{{ formCategoria.get('area')?.value }}</strong></span>
          </div>
        </div>

        <div class="form-field">
          <label for="categoria_id" class="form-label">
            <i class="pi pi-tag"></i>
            Seleccionar Categoría
            <span class="required">*</span>
          </label>
          <select
            id="categoria_id"
            formControlName="categoria_id"
            class="form-select"
            (change)="onCategoriaChange($event)"
          >
            <option value="">Seleccione una categoría</option>
            <option
              *ngFor="let categoria of categoriasFiltradas"
              [value]="categoria.id"
            >
              {{ categoria.nombre }}
            </option>
          </select>
        </div>

        <!-- Info de la Categoría Seleccionada -->
        <div *ngIf="categoriaSeleccionada" class="info-box">
          <div class="info-box-header">
            <i class="pi pi-tag"></i>
            <h4>{{ categoriaSeleccionada.nombre }}</h4>
          </div>
          <div class="info-box-content">
            <div class="info-item">
              <span class="info-label">Área:</span>
              <span class="info-value">{{
                categoriaSeleccionada.area_tipo
              }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Costo:</span>
              <span class="info-value highlight">{{
                categoriaSeleccionada.costo | currencyCop
              }}</span>
            </div>
          </div>
        </div>

        <!-- Costo Personalizado (si es variable) -->
        <div *ngIf="categoriaSeleccionada?.es_variable" class="form-field">
          <label for="costo_custom" class="form-label">
            <i class="pi pi-money-bill"></i>
            Costo Personalizado
            <span class="required">*</span>
          </label>
          <input
            type="number"
            id="costo_custom"
            formControlName="costo_custom"
            class="form-input"
            placeholder="Ingrese el costo"
            min="1"
          />
        </div>
      </form>
    </div>

    <!-- PASO 3: Descripción -->
    <div *ngIf="activeIndex === 2" class="step-content">
      <form [formGroup]="formDescripcion" class="step-form">
        <div class="form-field">
          <label for="descripcion" class="form-label">
            <i class="pi pi-file-edit"></i>
            Descripción
            <span class="required">*</span>
          </label>
          <textarea
            id="descripcion"
            formControlName="descripcion"
            rows="4"
            placeholder="Describa detalladamente la petición..."
            class="form-textarea"
          ></textarea>
          <small class="field-help">Mínimo 10 caracteres</small>
        </div>

        <!-- Descripción Extra (si es requerida) -->
        <div
          *ngIf="categoriaSeleccionada?.requiere_descripcion_extra"
          class="form-field"
        >
          <label for="descripcion_extra" class="form-label">
            <i class="pi pi-align-left"></i>
            Descripción Extra
            <span class="required">*</span>
          </label>
          <textarea
            id="descripcion_extra"
            formControlName="descripcion_extra"
            rows="3"
            placeholder="Información adicional requerida..."
            class="form-textarea"
          ></textarea>
        </div>
      </form>
    </div>

    <!-- PASO 4: Confirmar -->
    <div *ngIf="activeIndex === 3" class="step-content">
      <h3 class="summary-title">
        <i class="pi pi-check-circle"></i>
        Resumen de la Petición
      </h3>

      <div class="summary-box">
        <div class="summary-grid">
          <div class="summary-item">
            <label class="summary-label">
              <i class="pi pi-building"></i>
              Cliente
            </label>
            <p class="summary-value">{{ resumen.cliente?.nombre }}</p>
          </div>

          <div class="summary-item">
            <label class="summary-label">
              <i class="pi pi-tag"></i>
              Categoría
            </label>
            <p class="summary-value">{{ resumen.categoria?.nombre }}</p>
          </div>

          <div class="summary-item full-width">
            <label class="summary-label">
              <i class="pi pi-file-edit"></i>
              Descripción
            </label>
            <p class="summary-value description">{{ resumen.descripcion }}</p>
          </div>

          <div *ngIf="resumen.descripcionExtra" class="summary-item full-width">
            <label class="summary-label">
              <i class="pi pi-align-left"></i>
              Descripción Extra
            </label>
            <p class="summary-value description">
              {{ resumen.descripcionExtra }}
            </p>
          </div>

          <div class="summary-item full-width cost-item">
            <label class="summary-label">
              <i class="pi pi-money-bill"></i>
              Costo Total
            </label>
            <p class="summary-cost">{{ resumen.costo | currencyCop }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones de Navegación -->
  <div class="navigation-buttons" *ngIf="!loading">
    <button
      class="btn btn-secondary"
      (click)="prevStep()"
      *ngIf="activeIndex > 0"
      pTooltip="Volver al paso anterior"
      tooltipPosition="top"
    >
      <i class="pi pi-arrow-left"></i>
      Anterior
    </button>

    <button
      class="btn btn-primary"
      (click)="nextStep()"
      *ngIf="activeIndex < items.length - 1"
      pTooltip="Continuar al siguiente paso"
      tooltipPosition="top"
    >
      Siguiente
      <i class="pi pi-arrow-right"></i>
    </button>

    <button
      class="btn btn-success"
      (click)="crearPeticion()"
      *ngIf="activeIndex === items.length - 1"
      [disabled]="submitting"
      pTooltip="Crear la petición con los datos ingresados"
      tooltipPosition="top"
    >
      <i [class]="submitting ? 'pi pi-spin pi-spinner' : 'pi pi-check'"></i>
      {{ submitting ? "Creando..." : "Crear Petición" }}
    </button>
  </div>

  <!-- Toast Messages -->
  <div class="toast-container" *ngIf="toastMessage">
    <div class="toast" [class]="'toast-' + toastMessage.severity">
      <i [class]="getToastIcon()"></i>
      <div class="toast-content">
        <strong>{{ toastMessage.summary }}</strong>
        <p>{{ toastMessage.detail }}</p>
      </div>
      <button class="toast-close" (click)="closeToast()">
        <i class="pi pi-times"></i>
      </button>
    </div>
  </div>
</div>
