<div class="crear-peticion-page">
  <!-- Header -->
  <div class="page-header">
    <div class="header-left">
      <i class="pi pi-plus-circle header-icon"></i>
      <h2 class="page-title">Crear Nueva Petici칩n</h2>
    </div>
    <button 
      class="btn btn-cancel" 
      (click)="cancelar()"
      pTooltip="Cancelar y salir sin guardar"
      tooltipPosition="bottom"
    >
      <i class="pi pi-times"></i>
      Cancelar
    </button>
  </div>

  <!-- Steps -->
  <div class="steps-container">
    <div class="custom-steps">
      <div
        class="step-item"
        *ngFor="let item of items; let i = index"
        [class.active]="i === activeIndex"
        [class.completed]="i < activeIndex"
      >
        <div class="step-circle">
          <i [class]="item.icon"></i>
        </div>
        <span class="step-label">{{ item.label }}</span>
        <div class="step-line" *ngIf="i < items.length - 1"></div>
      </div>
    </div>
  </div>

  <!-- Loader -->
  <app-loader *ngIf="loading"></app-loader>

  <!-- Contenido Principal -->
  <div class="peticion-content" *ngIf="!loading">
    <!-- PASO 1: Seleccionar Cliente -->
    <div *ngIf="activeIndex === 0" class="step-content">
      <form [formGroup]="formCliente" class="step-form">
        <!-- Filtro por Pa칤s -->
        <div class="form-field">
          <label for="pais_filtro" class="form-label">
            <i class="pi pi-globe"></i>
            Filtrar por Pa칤s
            <span class="optional">(Opcional - facilita la b칰squeda)</span>
          </label>
          <select
            id="pais_filtro"
            class="form-select"
            (change)="onPaisChange($event)"
          >
            <option value="">Todos los pa칤ses ({{ clientes.length }} clientes)</option>
            <option *ngFor="let pais of paises" [value]="pais">
              {{ pais }} ({{ getClientesPorPais(pais) }} clientes)
            </option>
          </select>
          <small class="form-help" *ngIf="paisSeleccionado">
            <i class="pi pi-filter"></i>
            Mostrando {{ clientesFiltrados.length }} clientes de {{ paisSeleccionado }}
          </small>
        </div>

        <div class="form-field">
          <label for="cliente_id" class="form-label">
            <i class="pi pi-building"></i>
            Seleccionar Cliente
            <span class="required">*</span>
          </label>
          <select
            id="cliente_id"
            formControlName="cliente_id"
            class="form-select"
            (change)="onClienteChange($event)"
          >
            <option value="">{{ paisSeleccionado ? 'Seleccione un cliente' : 'Seleccione un cliente ('+clientesFiltrados.length+' disponibles)' }}</option>
            <option *ngFor="let cliente of clientesFiltrados" [value]="cliente.id">
              {{ cliente.nombre }} {{ paisSeleccionado ? '' : '(' + cliente.pais + ')' }}
            </option>
          </select>
          <small class="field-help" *ngIf="!paisSeleccionado && clientes.length > 20">
            游눠 Tip: Use el filtro de pa칤s arriba para encontrar clientes m치s r치pido
          </small>
        </div>

        <!-- Info del Cliente Seleccionado -->
        <div *ngIf="clienteSeleccionado" class="info-box">
          <div class="info-box-header">
            <i class="pi pi-info-circle"></i>
            <h4>Informaci칩n del Cliente</h4>
          </div>
          <div class="info-box-content">
            <div class="info-item">
              <span class="info-label">Nombre:</span>
              <span class="info-value">{{ clienteSeleccionado.nombre }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Pa칤s:</span>
              <span class="info-value">{{ clienteSeleccionado.pais }}</span>
            </div>
          </div>
        </div>
      </form>
    </div>

    <!-- PASO 2: Seleccionar Categor칤a -->
    <div *ngIf="activeIndex === 1" class="step-content">
      <form [formGroup]="formCategoria" class="step-form">
        <!-- Seleccionar 츼rea (visible para Admin, Pautas y Dise침o) -->
        <div class="form-field" *ngIf="mostrarSelectArea">
          <label for="area" class="form-label">
            <i class="pi pi-briefcase"></i>
            츼rea
            <span class="required">*</span>
          </label>
          <select id="area" formControlName="area" class="form-select" (change)="onAreaChange($event)">
            <option value="">Seleccione el 치rea</option>
            <option value="Dise침o">Dise침o</option>
            <option value="Pautas">Pautas</option>
            <!-- Solo Admin puede seleccionar Gesti칩n Administrativa -->
            <option value="Gesti칩n Administrativa" *ngIf="currentUser?.rol === 'Admin'">Gesti칩n Administrativa</option>
          </select>
          <small
            class="form-hint"
            *ngIf="formCategoria.value.area === 'Pautas'"
          >
            <i class="pi pi-info-circle"></i>
            Las peticiones de Pautas se asignan autom치ticamente al pautador del
            cliente
          </small>
        </div>

        <!-- Mensaje informativo cuando el 치rea est치 fija -->
        <div class="form-field" *ngIf="!mostrarSelectArea">
          <div class="info-message">
            <i class="pi pi-info-circle"></i>
            <span>Creando petici칩n para el 치rea de <strong>{{ formCategoria.get('area')?.value }}</strong></span>
          </div>
        </div>

        <div class="form-field">
          <label for="categoria_id" class="form-label">
            <i class="pi pi-tag"></i>
            Seleccionar Categor칤a
            <span class="required">*</span>
          </label>
          <select
            id="categoria_id"
            formControlName="categoria_id"
            class="form-select"
            (change)="onCategoriaChange($event)"
          >
            <option value="">Seleccione una categor칤a</option>
            <option
              *ngFor="let categoria of categoriasFiltradas"
              [value]="categoria.id"
            >
              {{ categoria.nombre }}
            </option>
          </select>
        </div>

        <!-- Info de la Categor칤a Seleccionada -->
        <div *ngIf="categoriaSeleccionada" class="info-box">
          <div class="info-box-header">
            <i class="pi pi-tag"></i>
            <h4>{{ categoriaSeleccionada.nombre }}</h4>
          </div>
          <div class="info-box-content">
            <div class="info-item">
              <span class="info-label">츼rea:</span>
              <span class="info-value">{{
                categoriaSeleccionada.area_tipo
              }}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Costo:</span>
              <span class="info-value highlight">{{
                categoriaSeleccionada.costo | currencyCop
              }}</span>
            </div>
          </div>
        </div>

        <!-- Costo Personalizado (si es variable) -->
        <div *ngIf="categoriaSeleccionada?.es_variable" class="form-field">
          <label for="costo_custom" class="form-label">
            <i class="pi pi-money-bill"></i>
            Costo Personalizado
            <span class="required">*</span>
          </label>
          <input
            type="number"
            id="costo_custom"
            formControlName="costo_custom"
            class="form-input"
            placeholder="Ingrese el costo"
            min="1"
          />
        </div>
      </form>
    </div>

    <!-- PASO 3: Descripci칩n -->
    <div *ngIf="activeIndex === 2" class="step-content">
      <form [formGroup]="formDescripcion" class="step-form">
        <div class="form-field">
          <label for="descripcion" class="form-label">
            <i class="pi pi-file-edit"></i>
            Descripci칩n
            <span class="required">*</span>
          </label>
          <textarea
            id="descripcion"
            formControlName="descripcion"
            rows="4"
            placeholder="Describa detalladamente la petici칩n..."
            class="form-textarea"
          ></textarea>
          <small class="field-help">M칤nimo 10 caracteres</small>
        </div>

        <!-- Descripci칩n Extra (si es requerida) -->
        <!-- OCULTO para Gesti칩n Administrativa -->
        <div
          *ngIf="categoriaSeleccionada?.requiere_descripcion_extra && !esGestionAdministrativa"
          class="form-field"
        >
          <label for="descripcion_extra" class="form-label">
            <i class="pi pi-align-left"></i>
            Descripci칩n Extra
            <span class="required">*</span>
          </label>
          <textarea
            id="descripcion_extra"
            formControlName="descripcion_extra"
            rows="3"
            placeholder="Informaci칩n adicional requerida..."
            class="form-textarea"
          ></textarea>
        </div>
      </form>
    </div>

    <!-- PASO 4: Confirmar -->
    <div *ngIf="activeIndex === 3" class="step-content">
      <h3 class="summary-title">
        <i class="pi pi-check-circle"></i>
        Resumen de la Petici칩n
      </h3>

      <div class="summary-box">
        <div class="summary-grid">
          <div class="summary-item">
            <label class="summary-label">
              <i class="pi pi-building"></i>
              Cliente
            </label>
            <p class="summary-value">{{ resumen.cliente?.nombre }}</p>
          </div>

          <div class="summary-item">
            <label class="summary-label">
              <i class="pi pi-tag"></i>
              Categor칤a
            </label>
            <p class="summary-value">{{ resumen.categoria?.nombre }}</p>
          </div>

          <div class="summary-item full-width">
            <label class="summary-label">
              <i class="pi pi-file-edit"></i>
              Descripci칩n
            </label>
            <p class="summary-value description">{{ resumen.descripcion }}</p>
          </div>

          <!-- OCULTO para Gesti칩n Administrativa -->
          <div *ngIf="resumen.descripcionExtra && !esGestionAdministrativa" class="summary-item full-width">
            <label class="summary-label">
              <i class="pi pi-align-left"></i>
              Descripci칩n Extra
            </label>
            <p class="summary-value description">
              {{ resumen.descripcionExtra }}
            </p>
          </div>

          <div class="summary-item full-width cost-item">
            <label class="summary-label">
              <i class="pi pi-money-bill"></i>
              Costo Total
            </label>
            <p class="summary-cost">{{ resumen.costo | currencyCop }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Botones de Navegaci칩n -->
  <div class="navigation-buttons" *ngIf="!loading">
    <button
      class="btn btn-secondary"
      (click)="prevStep()"
      *ngIf="activeIndex > 0"
      pTooltip="Volver al paso anterior"
      tooltipPosition="top"
    >
      <i class="pi pi-arrow-left"></i>
      Anterior
    </button>

    <button
      class="btn btn-primary"
      (click)="nextStep()"
      *ngIf="activeIndex < items.length - 1"
      pTooltip="Continuar al siguiente paso"
      tooltipPosition="top"
    >
      Siguiente
      <i class="pi pi-arrow-right"></i>
    </button>

    <button
      class="btn btn-success"
      (click)="crearPeticion()"
      *ngIf="activeIndex === items.length - 1"
      [disabled]="submitting"
      pTooltip="Crear la petici칩n con los datos ingresados"
      tooltipPosition="top"
    >
      <i [class]="submitting ? 'pi pi-spin pi-spinner' : 'pi pi-check'"></i>
      {{ submitting ? "Creando..." : "Crear Petici칩n" }}
    </button>
  </div>

  <!-- Toast Messages -->
  <div class="toast-container" *ngIf="toastMessage">
    <div class="toast" [class]="'toast-' + toastMessage.severity">
      <i [class]="getToastIcon()"></i>
      <div class="toast-content">
        <strong>{{ toastMessage.summary }}</strong>
        <p>{{ toastMessage.detail }}</p>
      </div>
      <button class="toast-close" (click)="closeToast()">
        <i class="pi pi-times"></i>
      </button>
    </div>
  </div>
</div>
