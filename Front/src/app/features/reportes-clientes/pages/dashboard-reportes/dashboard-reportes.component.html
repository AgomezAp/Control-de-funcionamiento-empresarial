<div class="dashboard-reportes p-4">
  <div class="header mb-4">
    <div class="flex justify-content-between align-items-center">
      <div>
        <h2 class="text-3xl font-bold m-0">Dashboard de Reportes</h2>
        <p class="text-gray-600 mt-2">Gestión de reportes de clientes</p>
      </div>
      <button 
        pButton 
        label="Nuevo Reporte" 
        icon="pi pi-plus" 
        class="p-button-success"
        (click)="crearReporte()">
      </button>
    </div>
  </div>

  <!-- KPIs -->
  <div class="grid" *ngIf="estadisticas">
    <div class="col-12 md:col-6 lg:col-3">
      <p-card>
        <div class="flex justify-content-between align-items-center">
          <div>
            <div class="text-gray-600 text-sm mb-2">Total Reportes</div>
            <div class="text-3xl font-bold text-primary">{{ estadisticas.total }}</div>
          </div>
          <div class="bg-primary-100 p-3 border-round">
            <i class="pi pi-file text-primary text-3xl"></i>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card>
        <div class="flex justify-content-between align-items-center">
          <div>
            <div class="text-gray-600 text-sm mb-2">Pendientes</div>
            <div class="text-3xl font-bold text-orange-500">{{ estadisticas.pendientes }}</div>
          </div>
          <div class="bg-orange-100 p-3 border-round">
            <i class="pi pi-clock text-orange-500 text-3xl"></i>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card>
        <div class="flex justify-content-between align-items-center">
          <div>
            <div class="text-gray-600 text-sm mb-2">En Atención</div>
            <div class="text-3xl font-bold text-blue-500">{{ estadisticas.enAtencion }}</div>
          </div>
          <div class="bg-blue-100 p-3 border-round">
            <i class="pi pi-user text-blue-500 text-3xl"></i>
          </div>
        </div>
      </p-card>
    </div>

    <div class="col-12 md:col-6 lg:col-3">
      <p-card>
        <div class="flex justify-content-between align-items-center">
          <div>
            <div class="text-gray-600 text-sm mb-2">Resueltos</div>
            <div class="text-3xl font-bold text-green-500">{{ estadisticas.resueltos }}</div>
          </div>
          <div class="bg-green-100 p-3 border-round">
            <i class="pi pi-check-circle text-green-500 text-3xl"></i>
          </div>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Gráfica y Reportes Recientes -->
  <div class="grid mt-4">
    <!-- Gráfica de Prioridad -->
    <div class="col-12 lg:col-6">
      <p-card header="Reportes por Prioridad" [style]="{'height': '400px'}">
        <p-chart 
          type="doughnut" 
          [data]="chartData" 
          [options]="chartOptions"
          *ngIf="chartData">
        </p-chart>
        
        <div *ngIf="!chartData" class="flex align-items-center justify-content-center" style="height: 300px;">
          <p class="text-gray-500">No hay datos para mostrar</p>
        </div>
      </p-card>
    </div>

    <!-- Tiempo Promedio y Reportes Recientes -->
    <div class="col-12 lg:col-6">
      <p-card header="Métricas y Actividad Reciente">
        <!-- Tiempo Promedio -->
        <div class="mb-4 p-3 bg-blue-50 border-round" *ngIf="estadisticas">
          <div class="flex align-items-center gap-3">
            <i class="pi pi-stopwatch text-blue-500 text-3xl"></i>
            <div>
              <div class="text-gray-600 text-sm">Tiempo Promedio de Resolución</div>
              <div class="text-2xl font-bold text-blue-600">
                {{ estadisticas.tiempoPromedioResolucion }} horas
              </div>
            </div>
          </div>
        </div>

        <p-divider></p-divider>

        <!-- Reportes Recientes -->
        <div class="mt-3">
          <div class="flex justify-content-between align-items-center mb-3">
            <h4 class="m-0">Reportes Recientes</h4>
            <button 
              pButton 
              label="Ver Todos" 
              icon="pi pi-arrow-right" 
              class="p-button-text p-button-sm"
              (click)="verTodosReportes()">
            </button>
          </div>

          <div *ngFor="let reporte of reportesRecientes" class="mb-3 p-3 border-round border-1 surface-border hover:surface-100 cursor-pointer"
               (click)="verReporte(reporte.id)">
            <div class="flex justify-content-between align-items-start">
              <div class="flex-grow-1">
                <div class="flex align-items-center gap-2 mb-2">
                  <i [class]="getTipoProblemaIcon(reporte.tipo_problema)" class="text-gray-600"></i>
                  <span class="font-bold">{{ reporte.cliente?.nombre || 'Cliente' }}</span>
                  <p-tag 
                    [value]="reporte.prioridad" 
                    [severity]="getPrioridadColor(reporte.prioridad)"
                    [rounded]="true">
                  </p-tag>
                </div>
                <p class="text-sm text-gray-600 m-0 line-height-3">
                  {{ reporte.descripcion_problema | slice:0:100 }}{{ reporte.descripcion_problema.length > 100 ? '...' : '' }}
                </p>
                <div class="text-xs text-gray-500 mt-2">
                  {{ formatearFecha(reporte.fecha_creacion) }}
                </div>
              </div>
              <p-tag 
                [value]="reporte.estado" 
                [severity]="getEstadoColor(reporte.estado)"
                class="ml-2">
              </p-tag>
            </div>
          </div>

          <div *ngIf="reportesRecientes.length === 0" class="text-center text-gray-500 py-4">
            <i class="pi pi-inbox text-4xl mb-3"></i>
            <p>No hay reportes recientes</p>
          </div>
        </div>
      </p-card>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="flex align-items-center justify-content-center" style="height: 400px;">
    <p-progressBar mode="indeterminate" [style]="{'width': '300px'}"></p-progressBar>
  </div>
</div>

<p-toast></p-toast>
